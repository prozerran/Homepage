<pre style='color:#000020;background:#f6f8ff;'>mports <span style='color:#200080; font-weight:bold; '>System</span><span style='color:#008c00; '>.</span>Data
<span style='color:#200080; font-weight:bold; '>Imports</span> <span style='color:#200080; font-weight:bold; '>System</span><span style='color:#008c00; '>.</span>Data<span style='color:#008c00; '>.</span>SqlClient
<span style='color:#200080; font-weight:bold; '>Imports</span> <span style='color:#200080; font-weight:bold; '>System</span><span style='color:#008c00; '>.</span>Collections<span style='color:#008c00; '>.</span>Generic
<span style='color:#200080; font-weight:bold; '>Imports</span> <span style='color:#200080; font-weight:bold; '>System</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span>

<span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Class</span> DBoxSqlConnection
    <span style='color:#200080; font-weight:bold; '>Implements</span> IDisposable

    <span style='color:#200080; font-weight:bold; '>Private</span> conn <span style='color:#200080; font-weight:bold; '>As</span> SqlConnection
    <span style='color:#200080; font-weight:bold; '>Private</span> trans <span style='color:#200080; font-weight:bold; '>As</span> SqlTransaction
    <span style='color:#200080; font-weight:bold; '>Private</span> cmdTimeOut <span style='color:#200080; font-weight:bold; '>As</span> Int32

    <span style='color:#595979; '>'Ignore the first '@RETURN_VALUE" parameter, so start from 1</span>
    <span style='color:#200080; font-weight:bold; '>Private</span> parameterShiftIndex <span style='color:#200080; font-weight:bold; '>As</span> Int32 <span style='color:#308080; '>=</span> <span style='color:#008c00; '>1</span>
    <span style='color:#200080; font-weight:bold; '>Private</span> <span style='color:#200080; font-weight:bold; '>ReadOnly</span> returnValue <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#1060b6; '>"@RETURN_VALUE"</span>

    <span style='color:#200080; font-weight:bold; '>Private</span> <span style='color:#200080; font-weight:bold; '>Shared</span> parameterCache <span style='color:#200080; font-weight:bold; '>As</span> Hashtable <span style='color:#308080; '>=</span> Hashtable<span style='color:#008c00; '>.</span>Synchronized<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>New</span> Hashtable<span style='color:#308080; '>)</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Shared</span> SyncLocker <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Enum</span> ExecuteType
        ExecuteScalar
        ExecuteNonQuery
        ExecuteReader
        ExecuteDataTable
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Enum</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> <span style='color:#200080; font-weight:bold; '>New</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        conn <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>New</span> SqlConnection<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> <span style='color:#200080; font-weight:bold; '>New</span><span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> connectionString <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span>
        conn <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>New</span> SqlConnection<span style='color:#308080; '>(</span>connectionString<span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>ReadOnly</span> <span style='color:#200080; font-weight:bold; '>Property</span> State<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> ConnectionState
        <span style='color:#200080; font-weight:bold; '>Get</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> conn<span style='color:#008c00; '>.</span>State
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Get</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Property</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Property</span> CommandTimeout<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> Int32
        <span style='color:#200080; font-weight:bold; '>Get</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> cmdTimeOut
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Get</span>
        <span style='color:#200080; font-weight:bold; '>Set</span><span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> value <span style='color:#200080; font-weight:bold; '>As</span> Int32<span style='color:#308080; '>)</span>
            cmdTimeOut <span style='color:#308080; '>=</span> value
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Set</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Property</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>ReadOnly</span> <span style='color:#200080; font-weight:bold; '>Property</span> InnerSQLConnection<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> SqlConnection
        <span style='color:#200080; font-weight:bold; '>Get</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> conn
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Get</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Property</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>ReadOnly</span> <span style='color:#200080; font-weight:bold; '>Property</span> InnerTrans<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> SqlTransaction
        <span style='color:#200080; font-weight:bold; '>Get</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> trans
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Get</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Property</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> <span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>If</span> conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
            conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> <span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> connectionString <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span>
        conn<span style='color:#008c00; '>.</span>ConnectionString <span style='color:#308080; '>=</span> connectionString
        conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> <span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>If</span> <span style='color:#200080; font-weight:bold; '>Not</span> conn <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> AndAlso conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span> <span style='color:#200080; font-weight:bold; '>Then</span>
            conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

<span style='color:#308080; '>#</span>Region <span style='color:#1060b6; '>"execute"</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> Execute<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> sqlText <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> Int32
        <span style='color:#200080; font-weight:bold; '>Return</span> Execute<span style='color:#308080; '>(</span>sqlText<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> Execute<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> sqlText <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> cmdType <span style='color:#200080; font-weight:bold; '>As</span> CommandType<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> Int32
        <span style='color:#200080; font-weight:bold; '>Return</span> <span style='color:#200080; font-weight:bold; '>CType</span><span style='color:#308080; '>(</span>Execute<span style='color:#308080; '>(</span>sqlText<span style='color:#308080; '>,</span> cmdType<span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Nothing</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> Int32<span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> Execute<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataTable
        <span style='color:#200080; font-weight:bold; '>Dim</span> closeConnAfterUse <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>If</span> conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                closeConnAfterUse <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>True</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> GetDataTable<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            <span style='color:#200080; font-weight:bold; '>If</span> closeConnAfterUse AndAlso conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>></span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>

    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> Execute<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> dataSetName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataSet
        <span style='color:#200080; font-weight:bold; '>Dim</span> closeConnAfterUse <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>If</span> conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                closeConnAfterUse <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>True</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> GetDataSet<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>,</span> dataSetName<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            <span style='color:#200080; font-weight:bold; '>If</span> closeConnAfterUse AndAlso conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>></span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>

    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> Execute<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> sqlText <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> cmdType <span style='color:#200080; font-weight:bold; '>As</span> CommandType<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> executeType <span style='color:#200080; font-weight:bold; '>As</span> ExecuteType<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> <span style='color:#200080; font-weight:bold; '>ParamArray</span> parameterValues<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>Nothing</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> closeConnAfterUse <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>If</span> conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                closeConnAfterUse <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>True</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

            cmd <span style='color:#308080; '>=</span> GetCommand<span style='color:#308080; '>(</span>sqlText<span style='color:#308080; '>,</span> cmdType<span style='color:#308080; '>,</span> parameterValues<span style='color:#308080; '>)</span>

            <span style='color:#200080; font-weight:bold; '>Select</span> <span style='color:#200080; font-weight:bold; '>Case</span> executeType
                <span style='color:#200080; font-weight:bold; '>Case</span> executeType<span style='color:#008c00; '>.</span>ExecuteNonQuery
                    <span style='color:#200080; font-weight:bold; '>Return</span> cmd<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>Case</span> executeType<span style='color:#008c00; '>.</span>ExecuteScalar
                    <span style='color:#200080; font-weight:bold; '>Return</span> cmd<span style='color:#008c00; '>.</span>ExecuteScalar<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>Case</span> executeType<span style='color:#008c00; '>.</span>ExecuteReader
                    <span style='color:#200080; font-weight:bold; '>Return</span> cmd<span style='color:#008c00; '>.</span>ExecuteReader<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>Case</span> executeType<span style='color:#008c00; '>.</span>ExecuteDataTable
                    <span style='color:#200080; font-weight:bold; '>Return</span> GetDataTable<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>Case</span> <span style='color:#200080; font-weight:bold; '>Else</span>
                    <span style='color:#200080; font-weight:bold; '>Return</span> <span style='color:#200080; font-weight:bold; '>Nothing</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Select</span>
        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            <span style='color:#200080; font-weight:bold; '>If</span> <span style='color:#200080; font-weight:bold; '>Not</span> cmd <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                cmd<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

            <span style='color:#200080; font-weight:bold; '>If</span> closeConnAfterUse AndAlso conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>></span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

<span style='color:#308080; '>#</span><span style='color:#200080; font-weight:bold; '>End</span> Region

<span style='color:#308080; '>#</span>Region <span style='color:#1060b6; '>"transaction"</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> BeginTrans<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        trans <span style='color:#308080; '>=</span> conn<span style='color:#008c00; '>.</span>BeginTransaction<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#595979; '>''Boris_20090916_ESS Spec Registration module</span>
    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> BeginTrans<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> level <span style='color:#200080; font-weight:bold; '>As</span> IsolationLevel<span style='color:#308080; '>)</span>
        trans <span style='color:#308080; '>=</span> conn<span style='color:#008c00; '>.</span>BeginTransaction<span style='color:#308080; '>(</span>level<span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>
    <span style='color:#595979; '>''Boris_20090916_End</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> CommitTrans<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        trans<span style='color:#008c00; '>.</span>Commit<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> RollbackTrans<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        trans<span style='color:#008c00; '>.</span>Rollback<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

<span style='color:#308080; '>#</span><span style='color:#200080; font-weight:bold; '>End</span> Region

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetCommand<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> sqlText <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> cmdType <span style='color:#200080; font-weight:bold; '>As</span> CommandType<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> <span style='color:#200080; font-weight:bold; '>ParamArray</span> parameterValues<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand
        <span style='color:#200080; font-weight:bold; '>Dim</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> SqlCommand<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> closeConnAfterUse <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> key <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#595979; '>'Set command properties</span>
            cmd<span style='color:#008c00; '>.</span>Connection <span style='color:#308080; '>=</span> conn
            cmd<span style='color:#008c00; '>.</span>CommandTimeout <span style='color:#308080; '>=</span> cmdTimeOut
            cmd<span style='color:#008c00; '>.</span>CommandText <span style='color:#308080; '>=</span> sqlText
            cmd<span style='color:#008c00; '>.</span>CommandType <span style='color:#308080; '>=</span> cmdType
            cmd<span style='color:#008c00; '>.</span>Transaction <span style='color:#308080; '>=</span> trans

            <span style='color:#595979; '>'Set parameters</span>
            <span style='color:#200080; font-weight:bold; '>If</span> parameterValues IsNot <span style='color:#200080; font-weight:bold; '>Nothing</span> AndAlso parameterValues<span style='color:#008c00; '>.</span>Length <span style='color:#308080; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                <span style='color:#200080; font-weight:bold; '>Select</span> <span style='color:#200080; font-weight:bold; '>Case</span> cmdType
                    <span style='color:#200080; font-weight:bold; '>Case</span> CommandType<span style='color:#008c00; '>.</span>StoredProcedure
                        <span style='color:#595979; '>'For stored procedure</span>
                        <span style='color:#200080; font-weight:bold; '>If</span> conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>=</span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                            conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Open</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
                            closeConnAfterUse <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>True</span>
                        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

                        <span style='color:#595979; '>'Check if parameter cached</span>
                        key <span style='color:#308080; '>=</span> GetCacheKey<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>

                        <span style='color:#200080; font-weight:bold; '>SyncLock</span> SyncLocker
                            <span style='color:#200080; font-weight:bold; '>If</span> parameterCache<span style='color:#008c00; '>.</span>ContainsKey<span style='color:#308080; '>(</span>key<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                                cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#008c00; '>.</span>AddRange<span style='color:#308080; '>(</span>CloneParameters<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>CType</span><span style='color:#308080; '>(</span>parameterCache<span style='color:#308080; '>(</span>key<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> IDataParameter<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
                            <span style='color:#200080; font-weight:bold; '>Else</span>
                                SqlCommandBuilder<span style='color:#008c00; '>.</span>DeriveParameters<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>

                                <span style='color:#200080; font-weight:bold; '>Dim</span> params <span style='color:#200080; font-weight:bold; '>As</span> IDataParameterCollection <span style='color:#308080; '>=</span> cmd<span style='color:#008c00; '>.</span>Parameters
                                <span style='color:#200080; font-weight:bold; '>Dim</span> paramsArray<span style='color:#308080; '>(</span>params<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>-</span> <span style='color:#008c00; '>1</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> IDataParameter
                                params<span style='color:#008c00; '>.</span>CopyTo<span style='color:#308080; '>(</span>paramsArray<span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>)</span>

                                parameterCache<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>key<span style='color:#308080; '>,</span> CloneParameters<span style='color:#308080; '>(</span>paramsArray<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
                            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
                        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>SyncLock</span>

                        <span style='color:#200080; font-weight:bold; '>If</span> <span style='color:#308080; '>(</span>cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>-</span> parameterShiftIndex <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>></span> parameterValues<span style='color:#008c00; '>.</span>Length<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> InvalidOperationException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Parameters' and Values' number is not match"</span><span style='color:#308080; '>)</span>
                        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

                        <span style='color:#200080; font-weight:bold; '>For</span> i <span style='color:#200080; font-weight:bold; '>As</span> Int32 <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>To</span> parameterValues<span style='color:#008c00; '>.</span>Length <span style='color:#308080; '>-</span> <span style='color:#008c00; '>1</span>
                            <span style='color:#200080; font-weight:bold; '>If</span> parameterValues<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                                cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>i <span style='color:#308080; '>+</span> parameterShiftIndex<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value <span style='color:#308080; '>=</span> DBNull<span style='color:#008c00; '>.</span>Value
                            <span style='color:#200080; font-weight:bold; '>Else</span>
                                cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>i <span style='color:#308080; '>+</span> parameterShiftIndex<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value <span style='color:#308080; '>=</span> parameterValues<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span>
                            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

                        <span style='color:#200080; font-weight:bold; '>Next</span>
                    <span style='color:#200080; font-weight:bold; '>Case</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span>
                        <span style='color:#595979; '>'For SQL Text, the SQL must be written as "SELECT * FROM XXX WHERE A=@0 AND B=@1 OR C=@2"</span>
                        <span style='color:#200080; font-weight:bold; '>For</span> i <span style='color:#200080; font-weight:bold; '>As</span> Int32 <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>To</span> parameterValues<span style='color:#008c00; '>.</span>Length <span style='color:#308080; '>-</span> <span style='color:#008c00; '>1</span>
                            <span style='color:#200080; font-weight:bold; '>If</span> parameterValues<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                                cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>New</span> SqlParameter<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"@"</span> <span style='color:#308080; '>&amp;</span> i<span style='color:#008c00; '>.</span>ToString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> DBNull<span style='color:#008c00; '>.</span>Value<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
                            <span style='color:#200080; font-weight:bold; '>Else</span>
                                cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>New</span> SqlParameter<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"@"</span> <span style='color:#308080; '>&amp;</span> i<span style='color:#008c00; '>.</span>ToString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> parameterValues<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
                            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

                        <span style='color:#200080; font-weight:bold; '>Next</span>

                    <span style='color:#200080; font-weight:bold; '>Case</span> <span style='color:#200080; font-weight:bold; '>Else</span>
                        <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> ArgumentException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Parameters are only supported for SQL text and stored procedure"</span><span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Select</span>

            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

            <span style='color:#200080; font-weight:bold; '>Return</span> cmd
        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            <span style='color:#200080; font-weight:bold; '>If</span> closeConnAfterUse AndAlso conn<span style='color:#008c00; '>.</span>State <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>></span> ConnectionState<span style='color:#008c00; '>.</span>Closed <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Close</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetParameterValue<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> parameterName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span>
        <span style='color:#200080; font-weight:bold; '>If</span> cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>parameterName<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value <span style='color:#200080; font-weight:bold; '>Is</span> DBNull<span style='color:#008c00; '>.</span>Value <span style='color:#200080; font-weight:bold; '>Then</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> <span style='color:#200080; font-weight:bold; '>Nothing</span>
        <span style='color:#200080; font-weight:bold; '>Else</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>parameterName<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetParameterValue<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> parameterIndex <span style='color:#200080; font-weight:bold; '>As</span> Int32<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span>
        <span style='color:#200080; font-weight:bold; '>If</span> cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>parameterIndex<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value <span style='color:#200080; font-weight:bold; '>Is</span> DBNull<span style='color:#008c00; '>.</span>Value <span style='color:#200080; font-weight:bold; '>Then</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> <span style='color:#200080; font-weight:bold; '>Nothing</span>
        <span style='color:#200080; font-weight:bold; '>Else</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> cmd<span style='color:#008c00; '>.</span>Parameters<span style='color:#308080; '>(</span>parameterIndex<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Value
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetReturnValue<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> returnParameterName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span>
        <span style='color:#200080; font-weight:bold; '>Return</span> GetParameterValue<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>,</span> returnParameterName<span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetReturnValue<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span>
        <span style='color:#200080; font-weight:bold; '>Return</span> GetReturnValue<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>,</span> returnValue<span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetDataTable<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmdText <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataTable
        <span style='color:#200080; font-weight:bold; '>Return</span> GetDataTable<span style='color:#308080; '>(</span>GetCommand<span style='color:#308080; '>(</span>cmdText<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Nothing</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetDataTable<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataTable


        <span style='color:#200080; font-weight:bold; '>Dim</span> da <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> SqlDataAdapter<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> tbl <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> DataTable<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"UniSign.Database.DataTable"</span><span style='color:#308080; '>)</span> <span style='color:#595979; '>'Just for a name in order to be serialzed when calling in web services</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>

            da<span style='color:#008c00; '>.</span>Fill<span style='color:#308080; '>(</span>tbl<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> tbl<span style='color:#008c00; '>.</span>Copy<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            tbl<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            da<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetDataSet<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> dataSetName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataSet


        <span style='color:#200080; font-weight:bold; '>Dim</span> da <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> SqlDataAdapter<span style='color:#308080; '>(</span>cmd<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> ds <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> DataSet<span style='color:#308080; '>(</span>dataSetName<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>

            da<span style='color:#008c00; '>.</span>Fill<span style='color:#308080; '>(</span>ds<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> ds<span style='color:#008c00; '>.</span>Copy<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
            ds<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            da<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Private</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetCacheKey<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> cmd <span style='color:#200080; font-weight:bold; '>As</span> SqlCommand<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span>
        <span style='color:#200080; font-weight:bold; '>Return</span> conn<span style='color:#008c00; '>.</span>ConnectionString <span style='color:#308080; '>&amp;</span> <span style='color:#1060b6; '>":"</span> <span style='color:#308080; '>&amp;</span> cmd<span style='color:#008c00; '>.</span>CommandText
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Private</span> <span style='color:#200080; font-weight:bold; '>Function</span> CloneParameters<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> parametersArray<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> IDataParameter<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> IDataParameter<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> cloneArray<span style='color:#308080; '>(</span>parametersArray<span style='color:#008c00; '>.</span>Length <span style='color:#308080; '>-</span> <span style='color:#008c00; '>1</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> IDataParameter
        <span style='color:#200080; font-weight:bold; '>For</span> i <span style='color:#200080; font-weight:bold; '>As</span> Int32 <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>To</span> parametersArray<span style='color:#008c00; '>.</span>Length <span style='color:#308080; '>-</span> <span style='color:#008c00; '>1</span>
            cloneArray<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>CType</span><span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>CType</span><span style='color:#308080; '>(</span>parametersArray<span style='color:#308080; '>(</span>i<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> ICloneable<span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>Clone<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> IDataParameter<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Next</span>

        <span style='color:#200080; font-weight:bold; '>Return</span> cloneArray
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetData<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> tableName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> DataTable
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> sql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"SELECT * FROM {0} WITH(NOLOCK) "</span><span style='color:#308080; '>,</span> tableName<span style='color:#308080; '>)</span>

            <span style='color:#595979; '>'Set condition</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> whereSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> values <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#308080; '>=</span> GetSelectedItemFilterValuesAndSQL<span style='color:#308080; '>(</span>filter<span style='color:#308080; '>,</span> whereSql<span style='color:#308080; '>)</span>

            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> whereSql

            <span style='color:#200080; font-weight:bold; '>Return</span> DirectCast<span style='color:#308080; '>(</span>Execute<span style='color:#308080; '>(</span>sql<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteDataTable<span style='color:#308080; '>,</span> values<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> DataTable<span style='color:#308080; '>)</span>

        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Sub</span> DeleteData<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> tableName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Dim</span> closeAfterUse <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> sql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Delete FROM {0}"</span><span style='color:#308080; '>,</span> tableName<span style='color:#308080; '>)</span>

            <span style='color:#595979; '>'Set condition</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> whereSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> values <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#308080; '>=</span> GetSelectedItemFilterValuesAndSQL<span style='color:#308080; '>(</span>filter<span style='color:#308080; '>,</span> whereSql<span style='color:#308080; '>)</span>

            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> whereSql

            Execute<span style='color:#308080; '>(</span>sql<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>,</span> values<span style='color:#308080; '>)</span>

        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Sub</span> InsertData<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> tableName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> sql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"insert into {0} "</span><span style='color:#308080; '>,</span> tableName<span style='color:#308080; '>)</span>

            <span style='color:#595979; '>'Update</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> insertSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#1060b6; '>" ({0}) values ({1})"</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> s1 <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> s2 <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> values <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> List<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>If</span> filter <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> OrElse filter<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                insertSql <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
                <span style='color:#200080; font-weight:bold; '>Return</span>
            <span style='color:#200080; font-weight:bold; '>Else</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> keyIndex <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> i <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> key <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
                <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> KeyValuePair<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>In</span> filter
                    <span style='color:#200080; font-weight:bold; '>If</span> s1 <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                        s1 <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> item<span style='color:#008c00; '>.</span>Key
                    <span style='color:#200080; font-weight:bold; '>Else</span>
                        s1 <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" ,{0} "</span><span style='color:#308080; '>,</span> item<span style='color:#008c00; '>.</span>Key<span style='color:#308080; '>)</span>
                    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
                    <span style='color:#200080; font-weight:bold; '>If</span> s2 <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                        s2 <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"@{0} "</span><span style='color:#308080; '>,</span> i<span style='color:#308080; '>)</span>
                    <span style='color:#200080; font-weight:bold; '>Else</span>
                        s2 <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" ,@{0} "</span><span style='color:#308080; '>,</span> i<span style='color:#308080; '>)</span>
                    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
                    i <span style='color:#308080; '>+</span><span style='color:#308080; '>=</span> <span style='color:#008c00; '>1</span>
                    values<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>item<span style='color:#008c00; '>.</span>Value<span style='color:#308080; '>)</span>
                <span style='color:#200080; font-weight:bold; '>Next</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
            insertSql <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span>insertSql<span style='color:#308080; '>,</span> s1<span style='color:#308080; '>,</span> s2<span style='color:#308080; '>)</span>
            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> insertSql
            Execute<span style='color:#308080; '>(</span>sql<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>,</span> values<span style='color:#008c00; '>.</span>ToArray<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>

        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Sub</span> UpdateData<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> tableName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> update <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> sql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Update {0} set "</span><span style='color:#308080; '>,</span> tableName<span style='color:#308080; '>)</span>

            <span style='color:#595979; '>'Update</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> updateSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>If</span> update <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> OrElse update<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                updateSql <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
                <span style='color:#200080; font-weight:bold; '>Return</span>
            <span style='color:#200080; font-weight:bold; '>Else</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> keyIndex <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> i <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
                <span style='color:#200080; font-weight:bold; '>Dim</span> key <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
                <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> KeyValuePair<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>In</span> update
                    key <span style='color:#308080; '>=</span> item<span style='color:#008c00; '>.</span>Key
                    <span style='color:#200080; font-weight:bold; '>If</span> updateSql <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span> <span style='color:#200080; font-weight:bold; '>Then</span>
                        updateSql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"{0}=@{1} "</span><span style='color:#308080; '>,</span> key<span style='color:#308080; '>,</span> i <span style='color:#308080; '>+</span> filter<span style='color:#008c00; '>.</span>Count<span style='color:#308080; '>)</span>
                    <span style='color:#200080; font-weight:bold; '>Else</span>
                        updateSql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" ,{0}=@{1} "</span><span style='color:#308080; '>,</span> key<span style='color:#308080; '>,</span> i <span style='color:#308080; '>+</span> filter<span style='color:#008c00; '>.</span>Count<span style='color:#308080; '>)</span>
                    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
                    i <span style='color:#308080; '>+</span><span style='color:#308080; '>=</span> <span style='color:#008c00; '>1</span>
                <span style='color:#200080; font-weight:bold; '>Next</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> updateSql
            <span style='color:#595979; '>'Set condition</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> whereSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> values <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#308080; '>=</span> GetSelectedItemFilterValuesAndSQL<span style='color:#308080; '>(</span>filter<span style='color:#308080; '>,</span> whereSql<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> collection <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> List<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span> <span style='color:#200080; font-weight:bold; '>In</span> values
                collection<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>item<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Next</span>
            <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> KeyValuePair<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>In</span> update
                collection<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>item<span style='color:#008c00; '>.</span>Value<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Next</span>

            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> whereSql

            Execute<span style='color:#308080; '>(</span>sql<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>,</span> collection<span style='color:#008c00; '>.</span>ToArray<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>

        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Sub</span> UpdateTime<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> tableName <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> CompareTime <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> NewTime <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Try</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> sql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Update {0} set "</span><span style='color:#308080; '>,</span> tableName<span style='color:#308080; '>)</span>

            <span style='color:#595979; '>'Update</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> updateSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" LastUpdateDateTime=@{0} "</span><span style='color:#308080; '>,</span> filter<span style='color:#008c00; '>.</span>Count<span style='color:#308080; '>)</span>

            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> updateSql
            <span style='color:#595979; '>'Set condition</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> whereSql <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> values <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#308080; '>=</span> GetSelectedItemFilterValuesAndSQL<span style='color:#308080; '>(</span>filter<span style='color:#308080; '>,</span> whereSql<span style='color:#308080; '>)</span>
            whereSql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" and (LastUpdateDateTime&lt;@{0} or LastUpdateDateTime is NULL)"</span><span style='color:#308080; '>,</span> filter<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>+</span> <span style='color:#008c00; '>1</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> collection <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> List<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span> <span style='color:#200080; font-weight:bold; '>In</span> values
                collection<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>item<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Next</span>
            collection<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>NewTime<span style='color:#308080; '>)</span>
            collection<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>CompareTime<span style='color:#308080; '>)</span>

            sql <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>=</span> whereSql

            Execute<span style='color:#308080; '>(</span>sql<span style='color:#308080; '>,</span> CommandType<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Text</span><span style='color:#308080; '>,</span> ExecuteType<span style='color:#008c00; '>.</span>ExecuteNonQuery<span style='color:#308080; '>,</span> collection<span style='color:#008c00; '>.</span>ToArray<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>

        <span style='color:#200080; font-weight:bold; '>Catch</span> ex <span style='color:#200080; font-weight:bold; '>As</span> Exception
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>Message<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Connection string:"</span> <span style='color:#308080; '>+</span> conn<span style='color:#008c00; '>.</span>ConnectionString<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Log</span><span style='color:#008c00; '>.</span>Instance<span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Error</span><span style='color:#308080; '>(</span>ex<span style='color:#008c00; '>.</span>StackTrace<span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Throw</span> <span style='color:#200080; font-weight:bold; '>New</span> CustomException<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Cannot connect to Dropbox database server."</span><span style='color:#308080; '>,</span> ex<span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>Finally</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Try</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#595979; '>''' &lt;summary></span>
    <span style='color:#595979; '>''' Get the filter values array for the selected record and return the WHERE SQL statement through output parameter</span>
    <span style='color:#595979; '>''' &lt;/summary></span>
    <span style='color:#595979; '>''' &lt;param name="filter">&lt;/param></span>
    <span style='color:#595979; '>''' &lt;param name="filterSQL">&lt;/param></span>
    <span style='color:#595979; '>''' &lt;returns>&lt;/returns></span>
    <span style='color:#595979; '>''' &lt;remarks>&lt;/remarks></span>
    <span style='color:#200080; font-weight:bold; '>Protected</span> <span style='color:#200080; font-weight:bold; '>Function</span> GetSelectedItemFilterValuesAndSQL<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> filter <span style='color:#200080; font-weight:bold; '>As</span> Dictionary<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>ByRef</span> filterSQL <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#595979; '>'Set filter</span>
        <span style='color:#200080; font-weight:bold; '>If</span> filter <span style='color:#200080; font-weight:bold; '>Is</span> <span style='color:#200080; font-weight:bold; '>Nothing</span> OrElse filter<span style='color:#008c00; '>.</span>Count <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#200080; font-weight:bold; '>Then</span>
            filterSQL <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> <span style='color:#200080; font-weight:bold; '>Nothing</span>
        <span style='color:#200080; font-weight:bold; '>Else</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> filterString <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> StringBuilder<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> filterValues <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>New</span> List<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> keyIndex <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> i <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Integer</span> <span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span>
            <span style='color:#200080; font-weight:bold; '>Dim</span> key <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>String</span> <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Empty</span>
            <span style='color:#200080; font-weight:bold; '>For</span> <span style='color:#200080; font-weight:bold; '>Each</span> item <span style='color:#200080; font-weight:bold; '>As</span> KeyValuePair<span style='color:#308080; '>(</span>Of <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>Object</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>In</span> filter
                key <span style='color:#308080; '>=</span> item<span style='color:#008c00; '>.</span>Key
                filterString<span style='color:#008c00; '>.</span>Append<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"AND {0}=@{1} "</span><span style='color:#308080; '>,</span> key<span style='color:#308080; '>,</span> i<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
                filterValues<span style='color:#008c00; '>.</span>Add<span style='color:#308080; '>(</span>item<span style='color:#008c00; '>.</span>Value<span style='color:#308080; '>)</span>
                i <span style='color:#308080; '>+</span><span style='color:#308080; '>=</span> <span style='color:#008c00; '>1</span>
            <span style='color:#200080; font-weight:bold; '>Next</span>

            filterSQL <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>String</span><span style='color:#008c00; '>.</span><span style='color:#200080; font-weight:bold; '>Format</span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>" WHERE 1=1 {0}"</span><span style='color:#308080; '>,</span> filterString<span style='color:#008c00; '>.</span>ToString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>Return</span> filterValues<span style='color:#008c00; '>.</span>ToArray<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Function</span>

<span style='color:#308080; '>#</span>Region <span style='color:#1060b6; '>"IDisposable members"</span>
    <span style='color:#200080; font-weight:bold; '>Private</span> disposedValue <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span> <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>False</span>        <span style='color:#595979; '>' To detect redundant calls</span>
    <span style='color:#595979; '>' IDisposable</span>
    <span style='color:#200080; font-weight:bold; '>Protected</span> <span style='color:#200080; font-weight:bold; '>Overridable</span> <span style='color:#200080; font-weight:bold; '>Sub</span> Dispose<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>ByVal</span> disposing <span style='color:#200080; font-weight:bold; '>As</span> <span style='color:#200080; font-weight:bold; '>Boolean</span><span style='color:#308080; '>)</span>
        <span style='color:#200080; font-weight:bold; '>If</span> <span style='color:#200080; font-weight:bold; '>Not</span> <span style='color:#200080; font-weight:bold; '>Me</span><span style='color:#008c00; '>.</span>disposedValue <span style='color:#200080; font-weight:bold; '>Then</span>
            <span style='color:#200080; font-weight:bold; '>If</span> disposing <span style='color:#200080; font-weight:bold; '>Then</span>
                conn<span style='color:#008c00; '>.</span>Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span>
            <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>

        <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>If</span>
        <span style='color:#200080; font-weight:bold; '>Me</span><span style='color:#008c00; '>.</span>disposedValue <span style='color:#308080; '>=</span> <span style='color:#0f4d75; '>True</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

    <span style='color:#595979; '>' This code added by Visual Basic to correctly implement the disposable pattern.</span>
    <span style='color:#200080; font-weight:bold; '>Public</span> <span style='color:#200080; font-weight:bold; '>Sub</span> Dispose<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>Implements</span> IDisposable<span style='color:#008c00; '>.</span>Dispose
        <span style='color:#595979; '>' Do not change this code.  Put cleanup code in Dispose(ByVal disposing As Boolean) above.</span>
        Dispose<span style='color:#308080; '>(</span><span style='color:#0f4d75; '>True</span><span style='color:#308080; '>)</span>
        GC<span style='color:#008c00; '>.</span>SuppressFinalize<span style='color:#308080; '>(</span><span style='color:#200080; font-weight:bold; '>Me</span><span style='color:#308080; '>)</span>
    <span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Sub</span>

<span style='color:#308080; '>#</span><span style='color:#200080; font-weight:bold; '>End</span> Region


<span style='color:#200080; font-weight:bold; '>End</span> <span style='color:#200080; font-weight:bold; '>Class</span>
</pre>
<!--Created using ToHtml.com on 2021-08-04 06:47:23 UTC -->