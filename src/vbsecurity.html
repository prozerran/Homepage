<pre style='color:#000000;background:#f1f0f0;'><span style='color:#400000; font-weight:bold; '>Option Explicit</span> <span style='color:#400000; font-weight:bold; '>On</span>
<span style='color:#400000; font-weight:bold; '>Option</span> <span style='color:#400000; font-weight:bold; '>Strict</span> <span style='color:#400000; font-weight:bold; '>On</span>

<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span>
<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>IO
<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Text</span>
<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security
<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security<span style='color:#8c0000; '>.</span>Cryptography
<span style='color:#400000; font-weight:bold; '>Imports</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Runtime<span style='color:#8c0000; '>.</span>InteropServices
<span style='color:#400000; font-weight:bold; '>Imports</span> SSCrypto

<span style='color:#400000; font-weight:bold; '>Imports</span> SSCommonLib<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Text</span>

<span style='color:#400000; font-weight:bold; '>Namespace</span> Security

  <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Class</span> Security

<span style='color:#806030; '>#</span>Region <span style='color:#e60000; '>"Const &amp; Variable"</span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Const</span> COMP_KEY <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#e60000; '>"SSViewer@COMP"</span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Const</span> COMP_KEY_HASH <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#e60000; '>"SHA1"</span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Const</span> COMP_KEY_ITERATION <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span> <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>2</span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Const</span> COMP_IV <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#e60000; '>"@COMP@20112031"</span>
<span style='color:#806030; '>#</span><span style='color:#400000; font-weight:bold; '>End</span> Region

<span style='color:#806030; '>#</span>Region <span style='color:#e60000; '>"SHA1 Hash"</span>

    <span style='color:#c34e00; '>''' &lt;summary></span>
    <span style='color:#c34e00; '>''' Generates a hash for the given plain text value and returns a base64-encoded result.</span>
    <span style='color:#c34e00; '>''' &lt;/summary></span>
    <span style='color:#c34e00; '>''' &lt;param name="plainText">Plaintext value to be hashed.The function does not check whether this parameter is null.&lt;/param></span>
    <span style='color:#c34e00; '>''' &lt;param name="saltBytes">Salt bytes. This parameter can be null, in which case a random salt value will be generated.&lt;/param></span>
    <span style='color:#c34e00; '>''' &lt;returns>Hash value formatted as a base64-encoded string.&lt;/returns></span>
    <span style='color:#c34e00; '>''' &lt;remarks>&lt;/remarks></span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> ComputeSHA1Hash<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> plainText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> saltBytes<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>
      <span style='color:#400000; font-weight:bold; '>If</span> <span style='color:#806030; '>(</span>saltBytes <span style='color:#400000; font-weight:bold; '>Is</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>Then</span>

        <span style='color:#c34e00; '>' Define min and max salt sizes.</span>
        <span style='color:#400000; font-weight:bold; '>Dim</span> minSaltSize <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>
        <span style='color:#400000; font-weight:bold; '>Dim</span> maxSaltSize <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>

        minSaltSize <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>4</span>
        maxSaltSize <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>8</span>

        <span style='color:#c34e00; '>' Generate a random number for the size of the salt.</span>
        <span style='color:#400000; font-weight:bold; '>Dim</span> random <span style='color:#400000; font-weight:bold; '>As</span> Random
        random <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> Random<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

        <span style='color:#400000; font-weight:bold; '>Dim</span> saltSize <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>
        saltSize <span style='color:#806030; '>=</span> random<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Next</span><span style='color:#806030; '>(</span>minSaltSize<span style='color:#806030; '>,</span> maxSaltSize<span style='color:#806030; '>)</span>

        <span style='color:#c34e00; '>' Allocate a byte array, which will hold the salt.</span>
        saltBytes <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span>saltSize <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span><span style='color:#806030; '>)</span> {}

        <span style='color:#c34e00; '>' Initialize a random number generator.</span>
        <span style='color:#400000; font-weight:bold; '>Dim</span> rng <span style='color:#400000; font-weight:bold; '>As</span> RNGCryptoServiceProvider
        rng <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> RNGCryptoServiceProvider<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

        <span style='color:#c34e00; '>' Fill the salt with cryptographically strong byte values.</span>
        rng<span style='color:#8c0000; '>.</span>GetNonZeroBytes<span style='color:#806030; '>(</span>saltBytes<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#c34e00; '>' Convert plain text into a byte array.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> plainTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
      plainTextBytes <span style='color:#806030; '>=</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>plainText<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Allocate array, which will hold plain text and salt.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> plainTextWithSaltBytes<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span>plainTextBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>+</span> saltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span><span style='color:#806030; '>)</span> {}
      <span style='color:#400000; font-weight:bold; '>Dim</span> I <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>
      <span style='color:#c34e00; '>' Copy plain text bytes into resulting array.</span>
      <span style='color:#400000; font-weight:bold; '>For</span> I <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>0</span> <span style='color:#400000; font-weight:bold; '>To</span> plainTextBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span>
        plainTextWithSaltBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> plainTextBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Next</span> I

      <span style='color:#c34e00; '>' Append salt bytes to the resulting array.</span>
      <span style='color:#400000; font-weight:bold; '>For</span> I <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>0</span> <span style='color:#400000; font-weight:bold; '>To</span> saltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span>
        plainTextWithSaltBytes<span style='color:#806030; '>(</span>plainTextBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>+</span> I<span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> saltBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Next</span> I

      <span style='color:#c34e00; '>' Because we support multiple hashing algorithms, we must define</span>
      <span style='color:#c34e00; '>' hash object as a common (abstract) base class. We will specify the</span>
      <span style='color:#c34e00; '>' actual hashing algorithm class later during object creation.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hash <span style='color:#400000; font-weight:bold; '>As</span> HashAlgorithm <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> SHA1Managed<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Compute hash value of our plain text with appended salt.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> hash<span style='color:#8c0000; '>.</span>ComputeHash<span style='color:#806030; '>(</span>plainTextWithSaltBytes<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Create array which will hold hash and original salt bytes.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashWithSaltBytes<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span>hashBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>+</span> saltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span><span style='color:#806030; '>)</span> {}

      <span style='color:#c34e00; '>' Copy hash bytes into resulting array.</span>
      <span style='color:#400000; font-weight:bold; '>For</span> I <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>0</span> <span style='color:#400000; font-weight:bold; '>To</span> hashBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span>
        hashWithSaltBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> hashBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Next</span> I

      <span style='color:#c34e00; '>' Append salt bytes to the result.</span>
      <span style='color:#400000; font-weight:bold; '>For</span> I <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>0</span> <span style='color:#400000; font-weight:bold; '>To</span> saltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span>
        hashWithSaltBytes<span style='color:#806030; '>(</span>hashBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>+</span> I<span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> saltBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Next</span> I

      <span style='color:#c34e00; '>' Convert result into a base64-encoded string.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashValue <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>
      hashValue <span style='color:#806030; '>=</span> Base64Converter<span style='color:#8c0000; '>.</span>ConvertToBase64<span style='color:#806030; '>(</span>hashWithSaltBytes<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Return the result.</span>
      <span style='color:#400000; font-weight:bold; '>Return</span> hashValue
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

    <span style='color:#c34e00; '>''' &lt;summary></span>
    <span style='color:#c34e00; '>''' Compares a hash of the specified plain text value to a given hash  value. Plain text is hashed with the same salt value as the original hash.</span>
    <span style='color:#c34e00; '>''' &lt;/summary></span>
    <span style='color:#c34e00; '>''' &lt;param name="plainText">Plain text to be verified against the specified hash. The function does not check whether this parameter is null.&lt;/param></span>
    <span style='color:#c34e00; '>''' &lt;param name="hashValue">Base64-encoded hash value produced by ComputeHash function. This value includes the original salt appended to it.&lt;/param></span>
    <span style='color:#c34e00; '>''' &lt;returns>Computed hash mathes the specified hash is true, otherwise false.&lt;/returns></span>
    <span style='color:#c34e00; '>''' &lt;remarks>&lt;/remarks></span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> VerifySHA1Hash<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> plainText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> hashValue <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Boolean</span>

      <span style='color:#c34e00; '>' Convert base64-encoded hash value into a byte array.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashWithSaltBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> Base64Converter<span style='color:#8c0000; '>.</span>ConvertBytesFromBase64<span style='color:#806030; '>(</span>hashValue<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' We must know size of hash (without salt).</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashSizeInBits <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> hashSizeInBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span>

      hashSizeInBits <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>160</span>

      <span style='color:#c34e00; '>' Convert size of hash from bits to bytes.</span>
      hashSizeInBytes <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>CInt</span><span style='color:#806030; '>(</span>hashSizeInBits <span style='color:#806030; '>/</span> <span style='color:#8c0000; '>8</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Make sure that the specified hash value is long enough.</span>
      <span style='color:#400000; font-weight:bold; '>If</span> <span style='color:#806030; '>(</span>hashWithSaltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>&lt;</span> hashSizeInBytes<span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        VerifySHA1Hash <span style='color:#806030; '>=</span> <span style='color:#0f4d75; '>False</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#c34e00; '>' Allocate array to hold original salt bytes retrieved from hash.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> saltBytes<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span>hashWithSaltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> hashSizeInBytes <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span><span style='color:#806030; '>)</span> {}

      <span style='color:#c34e00; '>' Copy salt from the end of the hash to the new array.</span>
      <span style='color:#400000; font-weight:bold; '>For</span> I <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span> <span style='color:#806030; '>=</span> <span style='color:#8c0000; '>0</span> <span style='color:#400000; font-weight:bold; '>To</span> saltBytes<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>-</span> <span style='color:#8c0000; '>1</span>
        saltBytes<span style='color:#806030; '>(</span>I<span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> hashWithSaltBytes<span style='color:#806030; '>(</span>hashSizeInBytes <span style='color:#806030; '>+</span> I<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Next</span> I

      <span style='color:#c34e00; '>' Compute a new hash string.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> expectedHashString <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> ComputeSHA1Hash<span style='color:#806030; '>(</span>plainText<span style='color:#806030; '>,</span> saltBytes<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' If the computed hash matches the specified hash,</span>
      <span style='color:#c34e00; '>' the plain text value must be correct.</span>
      <span style='color:#400000; font-weight:bold; '>Return</span> <span style='color:#806030; '>(</span>hashValue <span style='color:#806030; '>=</span> expectedHashString<span style='color:#806030; '>)</span>
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

<span style='color:#806030; '>#</span><span style='color:#400000; font-weight:bold; '>End</span> Region

<span style='color:#806030; '>#</span>Region <span style='color:#e60000; '>"AES256 Encrypt/Decypt"</span>

    <span style='color:#c34e00; '>''' &lt;summary></span>
    <span style='color:#c34e00; '>''' Encrypts specified plaintext using Rijndael(AES) symmetric key algorithm and returns a base64-encoded result.</span>
    <span style='color:#c34e00; '>''' &lt;/summary></span>
    <span style='color:#c34e00; '>''' &lt;returns>Encrypted value formatted as a base64-encoded string.&lt;/returns></span>
    <span style='color:#c34e00; '>''' &lt;remarks>&lt;/remarks></span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> AES256Encrypt<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> plainText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> key <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> IV <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> salt <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>

      <span style='color:#c34e00; '>' Convert our plaintext into a byte array.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> plainTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>plainText<span style='color:#806030; '>)</span>

      <span style='color:#400000; font-weight:bold; '>Return</span> AES256Encrypt<span style='color:#806030; '>(</span>plainTextBytes<span style='color:#806030; '>,</span> key<span style='color:#806030; '>,</span> IV<span style='color:#806030; '>,</span> salt<span style='color:#806030; '>)</span>
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> AES256Encrypt<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> plainTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> key <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> IV <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> salt <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>

      <span style='color:#400000; font-weight:bold; '>Dim</span> CryptKey <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security<span style='color:#8c0000; '>.</span>Cryptography<span style='color:#8c0000; '>.</span>PasswordDeriveBytes

      <span style='color:#400000; font-weight:bold; '>If</span> salt <span style='color:#400000; font-weight:bold; '>Is</span> <span style='color:#400000; font-weight:bold; '>Nothing</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        CryptKey <span style='color:#806030; '>=</span> GetCryptKey<span style='color:#806030; '>(</span>key<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Else</span>
        CryptKey <span style='color:#806030; '>=</span> GetCryptKey<span style='color:#806030; '>(</span>key<span style='color:#806030; '>,</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>salt<span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#c34e00; '>' Use the password to generate pseudo-random bytes for the encryption</span>
      <span style='color:#c34e00; '>' key. Specify the size of the key in bytes (instead of bits).</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> keyBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> CryptKey<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>CInt</span><span style='color:#806030; '>(</span><span style='color:#8c0000; '>256</span> <span style='color:#806030; '>/</span> <span style='color:#8c0000; '>8</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Create uninitialized Rijndael encryption object.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> symmetricKey <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> RijndaelManaged<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' It is reasonable to set encryption mode to Cipher Block Chaining</span>
      <span style='color:#c34e00; '>' (CBC). Use default options for other symmetric key parameters.</span>
      symmetricKey<span style='color:#8c0000; '>.</span>Mode <span style='color:#806030; '>=</span> CipherMode<span style='color:#8c0000; '>.</span>CBC

      <span style='color:#c34e00; '>' Generate encryptor from the existing key bytes and initialization </span>
      <span style='color:#c34e00; '>' vector. Key size will be defined based on the number of the key </span>
      <span style='color:#c34e00; '>' bytes.</span>
      <span style='color:#400000; font-weight:bold; '>If</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#8c0000; '>.</span>IsNullOrEmpty<span style='color:#806030; '>(</span>IV<span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        IV <span style='color:#806030; '>=</span> COMP_KEY
      <span style='color:#400000; font-weight:bold; '>Else</span>
        <span style='color:#400000; font-weight:bold; '>If</span> IV<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>&lt;</span> <span style='color:#8c0000; '>16</span> <span style='color:#400000; font-weight:bold; '>Then</span>
          IV <span style='color:#806030; '>=</span> IV <span style='color:#806030; '>&amp;</span> COMP_KEY<span style='color:#8c0000; '>.</span>Substring<span style='color:#806030; '>(</span><span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#8c0000; '>16</span> <span style='color:#806030; '>-</span> IV<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>
        <span style='color:#400000; font-weight:bold; '>ElseIf</span> IV<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>></span> <span style='color:#8c0000; '>16</span> <span style='color:#400000; font-weight:bold; '>Then</span>
          IV <span style='color:#806030; '>=</span> IV<span style='color:#8c0000; '>.</span>Substring<span style='color:#806030; '>(</span><span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#8c0000; '>16</span><span style='color:#806030; '>)</span>
        <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> encryptor <span style='color:#400000; font-weight:bold; '>As</span> ICryptoTransform <span style='color:#806030; '>=</span> symmetricKey<span style='color:#8c0000; '>.</span>CreateEncryptor<span style='color:#806030; '>(</span>keyBytes<span style='color:#806030; '>,</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>IV<span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Define memory stream which will be used to hold encrypted data.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> memoryStream <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> MemoryStream<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Define cryptographic stream (always use Write mode for encryption).</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> cryptoStream <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> CryptoStream<span style='color:#806030; '>(</span>memoryStream<span style='color:#806030; '>,</span> encryptor<span style='color:#806030; '>,</span> CryptoStreamMode<span style='color:#8c0000; '>.</span>Write<span style='color:#806030; '>)</span>
      <span style='color:#c34e00; '>' Start encrypting.</span>
      cryptoStream<span style='color:#8c0000; '>.</span>Write<span style='color:#806030; '>(</span>plainTextBytes<span style='color:#806030; '>,</span> <span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> plainTextBytes<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Finish encrypting.</span>
      cryptoStream<span style='color:#8c0000; '>.</span>FlushFinalBlock<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Convert our encrypted data from a memory stream into a byte array.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> cipherTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> memoryStream<span style='color:#8c0000; '>.</span>ToArray<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Close both streams.</span>
      memoryStream<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Close</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
      cryptoStream<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Close</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Convert encrypted data into a base64-encoded string.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> cipherText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>
      cipherText <span style='color:#806030; '>=</span> Base64Converter<span style='color:#8c0000; '>.</span>ConvertToBase64<span style='color:#806030; '>(</span>cipherTextBytes<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Return encrypted string.</span>
      <span style='color:#400000; font-weight:bold; '>Return</span> cipherText
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>


    <span style='color:#c34e00; '>''' &lt;summary></span>
    <span style='color:#c34e00; '>''' Decrypts specified ciphertext using Rijndael(AES) symmetric key algorithm.</span>
    <span style='color:#c34e00; '>''' &lt;/summary></span>
    <span style='color:#c34e00; '>''' &lt;returns>Decrypted string value.&lt;/returns></span>
    <span style='color:#c34e00; '>''' &lt;remarks>&lt;/remarks></span>
    <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> AES256Decrypt<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> cipherText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> key <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> IV <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> salt <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>

      <span style='color:#c34e00; '>' Convert our ciphertext into a byte array.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> cipherTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> Base64Converter<span style='color:#8c0000; '>.</span>ConvertBytesFromBase64<span style='color:#806030; '>(</span>cipherText<span style='color:#806030; '>)</span>

      <span style='color:#400000; font-weight:bold; '>Dim</span> CryptKey <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security<span style='color:#8c0000; '>.</span>Cryptography<span style='color:#8c0000; '>.</span>PasswordDeriveBytes

      <span style='color:#400000; font-weight:bold; '>If</span> salt <span style='color:#400000; font-weight:bold; '>Is</span> <span style='color:#400000; font-weight:bold; '>Nothing</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        CryptKey <span style='color:#806030; '>=</span> GetCryptKey<span style='color:#806030; '>(</span>key<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Else</span>
        CryptKey <span style='color:#806030; '>=</span> GetCryptKey<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>salt<span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#c34e00; '>' Use the password to generate pseudo-random bytes for the encryption</span>
      <span style='color:#c34e00; '>' key. Specify the size of the key in bytes (instead of bits).</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> keyBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> CryptKey<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>CInt</span><span style='color:#806030; '>(</span><span style='color:#8c0000; '>256</span> <span style='color:#806030; '>/</span> <span style='color:#8c0000; '>8</span><span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Create uninitialized Rijndael encryption object.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> symmetricKey <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> RijndaelManaged<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' It is reasonable to set encryption mode to Cipher Block Chaining</span>
      <span style='color:#c34e00; '>' (CBC). Use default options for other symmetric key parameters.</span>
      symmetricKey<span style='color:#8c0000; '>.</span>Mode <span style='color:#806030; '>=</span> CipherMode<span style='color:#8c0000; '>.</span>CBC

      <span style='color:#c34e00; '>' Generate decryptor from the existing key bytes and initialization </span>
      <span style='color:#c34e00; '>' vector. Key size will be defined based on the number of the key </span>
      <span style='color:#c34e00; '>' bytes.</span>

      <span style='color:#400000; font-weight:bold; '>If</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#8c0000; '>.</span>IsNullOrEmpty<span style='color:#806030; '>(</span>IV<span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        IV <span style='color:#806030; '>=</span> COMP_KEY
      <span style='color:#400000; font-weight:bold; '>Else</span>
        <span style='color:#400000; font-weight:bold; '>If</span> IV<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>&lt;</span> <span style='color:#8c0000; '>16</span> <span style='color:#400000; font-weight:bold; '>Then</span>
          IV <span style='color:#806030; '>=</span> IV <span style='color:#806030; '>&amp;</span> COMP_KEY<span style='color:#8c0000; '>.</span>Substring<span style='color:#806030; '>(</span><span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#8c0000; '>16</span> <span style='color:#806030; '>-</span> IV<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>
        <span style='color:#400000; font-weight:bold; '>ElseIf</span> IV<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>></span> <span style='color:#8c0000; '>16</span> <span style='color:#400000; font-weight:bold; '>Then</span>
          IV <span style='color:#806030; '>=</span> IV<span style='color:#8c0000; '>.</span>Substring<span style='color:#806030; '>(</span><span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#8c0000; '>16</span><span style='color:#806030; '>)</span>
        <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#400000; font-weight:bold; '>Dim</span> decryptor <span style='color:#400000; font-weight:bold; '>As</span> ICryptoTransform <span style='color:#806030; '>=</span> symmetricKey<span style='color:#8c0000; '>.</span>CreateDecryptor<span style='color:#806030; '>(</span>keyBytes<span style='color:#806030; '>,</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>COMP_KEY<span style='color:#806030; '>)</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Define memory stream which will be used to hold encrypted data.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> memoryStream <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> MemoryStream<span style='color:#806030; '>(</span>cipherTextBytes<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Define memory stream which will be used to hold encrypted data.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> cryptoStream <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>New</span> CryptoStream<span style='color:#806030; '>(</span>memoryStream<span style='color:#806030; '>,</span> decryptor<span style='color:#806030; '>,</span> CryptoStreamMode<span style='color:#8c0000; '>.</span>Read<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Since at this point we don't know what the size of decrypted data</span>
      <span style='color:#c34e00; '>' will be, allocate the buffer long enough to hold ciphertext;</span>
      <span style='color:#c34e00; '>' plaintext is never longer than ciphertext.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> plainTextBytes <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>ReDim</span> plainTextBytes<span style='color:#806030; '>(</span>cipherTextBytes<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Start decrypting.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> decryptedByteCount <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Integer</span> <span style='color:#806030; '>=</span> cryptoStream<span style='color:#8c0000; '>.</span>Read<span style='color:#806030; '>(</span>plainTextBytes<span style='color:#806030; '>,</span> <span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> plainTextBytes<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Close both streams.</span>
      memoryStream<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Close</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
      cryptoStream<span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Close</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Convert decrypted data into a string. </span>
      <span style='color:#c34e00; '>' Let us assume that the original plaintext string was UTF8-encoded.</span>
      <span style='color:#400000; font-weight:bold; '>Dim</span> plainText <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetString<span style='color:#806030; '>(</span>plainTextBytes<span style='color:#806030; '>,</span> <span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> decryptedByteCount<span style='color:#806030; '>)</span>

      <span style='color:#c34e00; '>' Return decrypted string.</span>
      <span style='color:#400000; font-weight:bold; '>Return</span> plainText
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

    <span style='color:#400000; font-weight:bold; '>Private</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> GetCryptKey<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> key <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>,</span> <span style='color:#400000; font-weight:bold; '>Optional</span> <span style='color:#400000; font-weight:bold; '>ByVal</span> salt <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>Nothing</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security<span style='color:#8c0000; '>.</span>Cryptography<span style='color:#8c0000; '>.</span>PasswordDeriveBytes
      <span style='color:#400000; font-weight:bold; '>If</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#8c0000; '>.</span>IsNullOrEmpty<span style='color:#806030; '>(</span>key<span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>Then</span>
        key <span style='color:#806030; '>=</span> COMP_KEY
      <span style='color:#400000; font-weight:bold; '>Else</span>
        <span style='color:#400000; font-weight:bold; '>If</span> key<span style='color:#8c0000; '>.</span>Length <span style='color:#806030; '>&lt;</span> <span style='color:#8c0000; '>16</span> <span style='color:#400000; font-weight:bold; '>Then</span> key <span style='color:#806030; '>=</span> key <span style='color:#806030; '>&amp;</span> COMP_KEY<span style='color:#8c0000; '>.</span>Substring<span style='color:#806030; '>(</span><span style='color:#8c0000; '>0</span><span style='color:#806030; '>,</span> <span style='color:#8c0000; '>16</span> <span style='color:#806030; '>-</span> key<span style='color:#8c0000; '>.</span>Length<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>If</span>

      <span style='color:#400000; font-weight:bold; '>If</span> salt <span style='color:#400000; font-weight:bold; '>Is</span> <span style='color:#400000; font-weight:bold; '>Nothing</span> <span style='color:#400000; font-weight:bold; '>Then</span> salt <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Text</span><span style='color:#8c0000; '>.</span>Encoding<span style='color:#8c0000; '>.</span>ASCII<span style='color:#8c0000; '>.</span>GetBytes<span style='color:#806030; '>(</span>COMP_IV<span style='color:#806030; '>)</span>
      <span style='color:#400000; font-weight:bold; '>Return</span> <span style='color:#400000; font-weight:bold; '>New</span> <span style='color:#400000; font-weight:bold; '>System</span><span style='color:#8c0000; '>.</span>Security<span style='color:#8c0000; '>.</span>Cryptography<span style='color:#8c0000; '>.</span>PasswordDeriveBytes<span style='color:#806030; '>(</span>key<span style='color:#806030; '>,</span> salt<span style='color:#806030; '>,</span> COMP_KEY_HASH<span style='color:#806030; '>,</span> COMP_KEY_ITERATION<span style='color:#806030; '>)</span>
    <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

<span style='color:#806030; '>#</span><span style='color:#400000; font-weight:bold; '>End</span> Region

<span style='color:#806030; '>#</span>Region <span style='color:#e60000; '>"TripleDES Decyption"</span>

        <span style='color:#400000; font-weight:bold; '>Public</span> <span style='color:#400000; font-weight:bold; '>Shared</span> <span style='color:#400000; font-weight:bold; '>Function</span> TripleDESDecrypt<span style='color:#806030; '>(</span><span style='color:#400000; font-weight:bold; '>ByVal</span> cipertext <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#806030; '>)</span> <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span>

            <span style='color:#400000; font-weight:bold; '>Try</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> keyFileLocation <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> ConfigReaderHelper<span style='color:#8c0000; '>.</span>GetSetting<span style='color:#806030; '>(</span><span style='color:#e60000; '>"KeyFile"</span><span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> cm <span style='color:#400000; font-weight:bold; '>As</span> SSCrypto<span style='color:#8c0000; '>.</span>CryptoModule <span style='color:#806030; '>=</span> <span style='color:#400000; font-weight:bold; '>New</span> SSCrypto<span style='color:#8c0000; '>.</span>CryptoModule<span style='color:#806030; '>(</span><span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> keyByte <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> File<span style='color:#8c0000; '>.</span>ReadAllBytes<span style='color:#806030; '>(</span>keyFileLocation<span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> key <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>String</span> <span style='color:#806030; '>=</span> cm<span style='color:#8c0000; '>.</span>UnMassageKey<span style='color:#806030; '>(</span>keyByte<span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> data <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> Base64Converter<span style='color:#8c0000; '>.</span>ConvertBytesFromBase64<span style='color:#806030; '>(</span>cipertext<span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Dim</span> result <span style='color:#400000; font-weight:bold; '>As</span> <span style='color:#400000; font-weight:bold; '>Byte</span><span style='color:#806030; '>(</span><span style='color:#806030; '>)</span> <span style='color:#806030; '>=</span> cm<span style='color:#8c0000; '>.</span>DecryptTripleDES<span style='color:#806030; '>(</span>key<span style='color:#806030; '>,</span> data<span style='color:#806030; '>)</span>
                <span style='color:#400000; font-weight:bold; '>Return</span> Encoding<span style='color:#8c0000; '>.</span>UTF8<span style='color:#8c0000; '>.</span>GetString<span style='color:#806030; '>(</span>result<span style='color:#806030; '>)</span>

            <span style='color:#400000; font-weight:bold; '>Catch</span> ex <span style='color:#400000; font-weight:bold; '>As</span> Exception
                <span style='color:#c34e00; '>'LogFile.WriteError(">Viewer Unable to Decrypt data. Except = " + ex.ToString())</span>
                <span style='color:#400000; font-weight:bold; '>Return</span> <span style='color:#400000; font-weight:bold; '>String</span><span style='color:#8c0000; '>.</span><span style='color:#400000; font-weight:bold; '>Empty</span>
            <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Try</span>

        <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Function</span>

<span style='color:#806030; '>#</span><span style='color:#400000; font-weight:bold; '>End</span> Region

  <span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Class</span>

<span style='color:#400000; font-weight:bold; '>End</span> <span style='color:#400000; font-weight:bold; '>Namespace</span>
</pre>