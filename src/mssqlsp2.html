<pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>USE</span> <span style='color:#808030; '>[</span>Database_DB<span style='color:#808030; '>]</span>
<span style='color:#800000; font-weight:bold; '>GO</span>
<span style='color:#696969; '>/****** Object:  StoredProcedure [dbo].[gtsp_interface_sap_sp]    Script Date: 12/21/2018 1:17:58 PM ******/</span>
<span style='color:#800000; font-weight:bold; '>SET</span> ANSI_NULLS <span style='color:#800000; font-weight:bold; '>ON</span>
<span style='color:#800000; font-weight:bold; '>GO</span>
<span style='color:#800000; font-weight:bold; '>SET</span> QUOTED_IDENTIFIER <span style='color:#800000; font-weight:bold; '>ON</span>
<span style='color:#800000; font-weight:bold; '>GO</span>

<span style='color:#696969; '>/*</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;Store Procedure for calculating Deferred Revenue for Finance Interface team</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;For every time the SP is ran, it recalculats and stores the day end revenue to [gtsd_sap_export_logs] table</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;and archives into [gtsd_sap_export_hist] table.</span>
<span style='color:#696969; '></span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;Accepts as parameters:</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;GalaxyRule          0 - All data</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;BusinessDateTime    - the date we wish to impersonate as (calculate value as if on that day)</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;OverrideExisting    - 0:No, Show current/new if not exist, 1:Yes, always recalculate and override</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;DebugFlag           - reserved only for development</span>
<span style='color:#696969; '></span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;Sample</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;DECLARE @dt datetime = getdate();</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;EXEC gtsp_interface_sap_sp 1, @dt, 0, 1     -- single day, save once, debug</span>
<span style='color:#696969; '>*/</span>

<span style='color:#696969; '>-- ============================================================================================================================</span>
<span style='color:#696969; '>-- Author:      Tim Hsu</span>
<span style='color:#696969; '>-- Description: Calculates Revenue</span>
<span style='color:#696969; '>-- ============================================================================================================================</span>

<span style='color:#800000; font-weight:bold; '>ALTER</span> <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#808030; '>[</span>dbo<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span><span style='color:#808030; '>[</span>gtsp_interface_sap_sp<span style='color:#808030; '>]</span> 
        <span style='color:#696969; '>-- Add the parameters for the stored procedure here</span>
        <span style='color:#797997; '>@GalaxyRule</span>         <span style='color:#800000; font-weight:bold; '>INT</span><span style='color:#808030; '>,</span>        <span style='color:#696969; '>-- Run for only rule#</span>
        <span style='color:#797997; '>@BusinessDateTime</span>   DATETIME<span style='color:#808030; '>,</span>   <span style='color:#696969; '>-- Impersonate date, run as if calculation was base on this date</span>
        <span style='color:#797997; '>@OverrideExisting</span>   <span style='color:#800000; font-weight:bold; '>INT</span><span style='color:#808030; '>,</span>        <span style='color:#696969; '>-- 0:No, 1:Yes</span>
        <span style='color:#797997; '>@DebugFlag</span>          <span style='color:#800000; font-weight:bold; '>INT</span>         <span style='color:#696969; '>-- Show debug info: 0-No show, 1-Show</span>
<span style='color:#800000; font-weight:bold; '>AS</span>
<span style='color:#800000; font-weight:bold; '>BEGIN</span>
        <span style='color:#696969; '>-- Force WITH(NOLOCK) for this sesion</span>
        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#800000; font-weight:bold; '>TRANSACTION</span> <span style='color:#800000; font-weight:bold; '>ISOLATION</span> <span style='color:#800000; font-weight:bold; '>LEVEL</span> <span style='color:#800000; font-weight:bold; '>READ</span> <span style='color:#800000; font-weight:bold; '>UNCOMMITTED</span>

        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@ExpirationDate</span>         DATETIME
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@StartCutoffDateTime</span>    DATETIME
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@CutoffDateTime</span>         DATETIME

        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#797997; '>@ExpirationDate</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span>  <span style='color:#696969; '>--For the calculation of the RemValue and Revenue and use to compare the ValidTo for filtering </span>
        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#797997; '>@ExpirationDate</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SECOND</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>86399</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>          <span style='color:#696969; '>-- -1 second before next day</span>
        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#797997; '>@CutoffDateTime</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>MINUTE</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1440</span> <span style='color:#808030; '>+</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>   <span style='color:#696969; '>-- +27.5 hours - Next day 3:30am cut off time       </span>
        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#797997; '>@StartCutoffDateTime</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>YEAR</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@CutoffDateTime</span><span style='color:#808030; '>)</span>           <span style='color:#696969; '>-- 1 day before cut off</span>
        <span style='color:#800000; font-weight:bold; '>SET</span> <span style='color:#797997; '>@BusinessDateTime</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>MINUTE</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>210</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span>         <span style='color:#696969; '>-- +3:30 to business date</span>

        <span style='color:#696969; '>-- Define ATS data exclusion</span>
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@excludeNodes</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#808030; '>(</span>NodeNo <span style='color:#800000; font-weight:bold; '>INT</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>INSERT</span> <span style='color:#800000; font-weight:bold; '>INTO</span> <span style='color:#797997; '>@excludeNodes</span> <span style='color:#800000; font-weight:bold; '>VALUES</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>100</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>200</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>300</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@excludeUsers</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#808030; '>(</span>UserId <span style='color:#800000; font-weight:bold; '>INT</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>INSERT</span> <span style='color:#800000; font-weight:bold; '>INTO</span> <span style='color:#797997; '>@excludeUsers</span> <span style='color:#800000; font-weight:bold; '>VALUES</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>100</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Hack for pre-updates</span>
        <span style='color:#800000; font-weight:bold; '>UPDATE</span> Expiration_Table
        <span style='color:#800000; font-weight:bold; '>SET</span> ValidToDate <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'2018-12-31 23:59:59'</span><span style='color:#808030; '>,</span> LastUpdate <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>WHERE</span> AccessCode <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>20017</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>20018</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>21001</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>21002</span><span style='color:#808030; '>)</span>
        
        <span style='color:#800000; font-weight:bold; '>UPDATE</span> Expiration_Table
        <span style='color:#800000; font-weight:bold; '>SET</span> ValidToDate <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'2018-11-30 23:59:59'</span><span style='color:#808030; '>,</span> LastUpdate <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>WHERE</span> AccessCode <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>21003</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>21004</span><span style='color:#808030; '>)</span>

        <span style='color:#696969; '>-- SET NOCOUNT ON added to prevent extra result sets from</span>
        <span style='color:#696969; '>-- interfering with SELECT statements.</span>
        <span style='color:#800000; font-weight:bold; '>SET</span> NOCOUNT <span style='color:#800000; font-weight:bold; '>ON</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': STARTED with:'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    GalaxyRule: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@GalaxyRule</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    BusinessDateTime: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    ExpirationDate: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    StartCutoffDateTime: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@StartCutoffDateTime</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    CutoffDateTime: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@CutoffDateTime</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    OverrideExisting: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@OverrideExisting</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    DebugFlag: '</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@DebugFlag</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Check if we have data in history table</span>
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@count</span> <span style='color:#800000; font-weight:bold; '>INT</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>COUNT</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_hist
            <span style='color:#800000; font-weight:bold; '>WHERE</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> BusinessDate<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#797997; '>@count</span> <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span>
        <span style='color:#800000; font-weight:bold; '>BEGIN</span>
            <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#797997; '>@OverrideExisting</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span>        <span style='color:#696969; '>-- data exist, retrieve and return it</span>
            <span style='color:#800000; font-weight:bold; '>BEGIN</span>
                <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  returning result set to caller'</span><span style='color:#808030; '>;</span>
                <span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#808030; '>*</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_hist <span style='color:#800000; font-weight:bold; '>WHERE</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> BusinessDate<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>                
                <span style='color:#800000; font-weight:bold; '>GOTO</span> Finalize<span style='color:#808030; '>;</span>      
            <span style='color:#800000; font-weight:bold; '>END</span>
            <span style='color:#800000; font-weight:bold; '>ELSE</span> <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#797997; '>@OverrideExisting</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>   <span style='color:#696969; '>-- data exist, erase it and regenerate</span>
                <span style='color:#800000; font-weight:bold; '>DELETE</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_hist <span style='color:#800000; font-weight:bold; '>WHERE</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> BusinessDate<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>END</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  creating temporary item views'</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Temporary view for later searching</span>
        <span style='color:#800000; font-weight:bold; '>CREATE</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#808030; '>#</span>temp_item_view_sp
        <span style='color:#808030; '>(</span>
            <span style='color:#800000; font-weight:bold; '>ID</span>                          <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span> <span style='color:#800000; font-weight:bold; '>IDENTITY</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>PRIMARY</span> <span style='color:#800000; font-weight:bold; '>KEY</span><span style='color:#808030; '>,</span>
            ItemID                      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            PLU                         NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            Descr                       NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>60</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            AccessCode                  <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            Name                        NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            ReportGroup                 NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>12</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            CalendarID                  <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            AttributeValueGroupID       <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            RevRule                     NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>       <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- for attribute CodeTableID = 35</span>
            RevNumVisits                NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>       <span style='color:#800000; font-weight:bold; '>NULL</span>        <span style='color:#696969; '>-- for attribute CodeTableID = 36</span>
        <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Populate our view item table</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span>
            <span style='color:#808030; '>#</span>temp_item_view_sp
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
            ItemID<span style='color:#808030; '>,</span>
            PLU<span style='color:#808030; '>,</span>
            Descr<span style='color:#808030; '>,</span>
            AccessCode<span style='color:#808030; '>,</span>
            Name<span style='color:#808030; '>,</span>
            ReportGroup<span style='color:#808030; '>,</span>
            CalendarID<span style='color:#808030; '>,</span>
            AttributeValueGroupID<span style='color:#808030; '>,</span>
            RevRule <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>
            RevNumVisits <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NULL</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span>
            gtsv_interface_sap_item_sp<span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- update revrule and numofvisits</span>
        <span style='color:#800000; font-weight:bold; '>UPDATE</span>
            iv
        <span style='color:#800000; font-weight:bold; '>SET</span>
            RevRule <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#800000; font-weight:bold; '>Value</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsv_interface_sap_attr_sp <span style='color:#800000; font-weight:bold; '>WHERE</span> PLU <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>PLU <span style='color:#800000; font-weight:bold; '>AND</span> CodeTableID <span style='color:#808030; '>=</span> <span style='color:#008c00; '>35</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            RevNumVisits <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#800000; font-weight:bold; '>Value</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsv_interface_sap_attr_sp <span style='color:#800000; font-weight:bold; '>WHERE</span> PLU <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>PLU <span style='color:#800000; font-weight:bold; '>AND</span> CodeTableID <span style='color:#808030; '>=</span> <span style='color:#008c00; '>36</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span>
            <span style='color:#808030; '>#</span>temp_item_view_sp iv

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  recreating [gtsd_sap_export_logs] table'</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Recreate Permanent Revenue Recognition Table</span>
        
        <span style='color:#800000; font-weight:bold; '>DROP</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#800000; font-weight:bold; '>EXISTS</span> gtsd_sap_export_logs<span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>CREATE</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> gtsd_sap_export_logs
        <span style='color:#808030; '>(</span>
            ExportDate      <span style='color:#800000; font-weight:bold; '>DATE</span>                <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- date record was generated</span>
            ExportTime      NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span>         <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- time record was generated</span>
            BusinessDate    DATETIME            <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- impersonate date</span>
            VisualID        NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- barcode</span>
            AccessCode      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- item type</span>
            ValidFrom       DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- real adjusted valid/start date</span>
            ValidTo         DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- real adjusted expiration date</span>
            RevRule         NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>       <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- from attribute CodeTableID = 35</span>
            GalaxyRule      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- galaxy rule</span>
            Channel         <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- 0:Company, 1:wholesaler</span>
            RemValue        <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- remaining value</span>
            Price           MONEY               <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- item sold price</span>
            PLU             NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- PLU</span>
            DefRevenue      MONEY               <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- deferred revenue</span>
            <span style='color:#800000; font-weight:bold; '>INDEX</span> IXBusinessDate <span style='color:#808030; '>(</span>BusinessDate<span style='color:#808030; '>)</span>                 <span style='color:#696969; '>-- index on datetime for easy searching</span>
        <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
        
        <span style='color:#696969; '>-- Temporary table for tickets, passes, packages, etc</span>
        <span style='color:#800000; font-weight:bold; '>CREATE</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#808030; '>#</span>temp_item_sp
        <span style='color:#808030; '>(</span>
            <span style='color:#800000; font-weight:bold; '>ID</span>              <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span> <span style='color:#800000; font-weight:bold; '>IDENTITY</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>PRIMARY</span> <span style='color:#800000; font-weight:bold; '>KEY</span><span style='color:#808030; '>,</span>
            ExportDate      <span style='color:#800000; font-weight:bold; '>DATE</span>                <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- date record was generated</span>
            ExportTime      NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span>         <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- time record was generated</span>
            BusinessDate    DATETIME            <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- impersonate date run on/as</span>
            TransDate       DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- transaction start date time</span>
            ItemID          <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- TicketID, PassNO, etc</span>
            NodeNo          <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- Node number</span>
            UserId          <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- User</span>
            VisualID        NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- barcode</span>
            AccessCode      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- item type</span>
            IssueDate       DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- system issue date</span>
            Status          <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- validity flag</span>
            Price           MONEY               <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- sold price</span>
            PLU             NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>)</span>        <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- PLU</span>
            CustomerID      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- client id</span>
            ValidFromDate   DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- productdef start date</span>
            ValidToDate     DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- productdef expire date</span>
            RevRule         NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>       <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- from attribute CodeTableID = 35</span>
            GalaxyRule      <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- galaxy rule</span>
            RevNumVisits    NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>       <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- from attribute CodeTableID = 36</span>
            MaxNumUsage     <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- entitlement</span>
            NumUsage        <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- total number usage</span>
            Channel         <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- 0:Company, 1:wholesaler</span>
            RemValue        <span style='color:#800000; font-weight:bold; '>INT</span>                 <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>       <span style='color:#696969; '>-- remaining value</span>
            ValidFrom       DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- real adjusted valid/start date</span>
            ValidTo         DATETIME            <span style='color:#800000; font-weight:bold; '>NULL</span><span style='color:#808030; '>,</span>           <span style='color:#696969; '>-- real adjusted expiration date</span>
            DefRevenue      MONEY               <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>NULL</span>        <span style='color:#696969; '>-- deferred revenue</span>
        <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  populating temp table with Tickets'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Insert all valid tickets in our temp table</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span>
            <span style='color:#808030; '>#</span>temp_item_sp
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span>NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>108</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            BusinessDate <span style='color:#808030; '>=</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>DateSold<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>Ticketid<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>NodeNo<span style='color:#808030; '>,</span>
            UserId <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>AccessCode<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>DateSold<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>Status<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>Price<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>PLU<span style='color:#808030; '>,</span>
            tk<span style='color:#808030; '>.</span>CustomerID<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            RevRule <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevRule<span style='color:#808030; '>,</span>
            GalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RevNumVisits <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevNumVisits<span style='color:#808030; '>,</span>
            MaxNumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
            NumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            Channel <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RemValue <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            ValidFrom <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            ValidTo <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            DefRevenue <span style='color:#808030; '>=</span> <span style='color:#008000; '>0.00</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span>
            JnlHeaders jh 
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlDetails jd <span style='color:#800000; font-weight:bold; '>ON</span> jh<span style='color:#808030; '>.</span>JnlTranID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlTranID  
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlTickets jt <span style='color:#800000; font-weight:bold; '>ON</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlDetailID 
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            Tickets tk <span style='color:#800000; font-weight:bold; '>ON</span> tk<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID <span style='color:#696969; '>--AND tk.PLU = jt.PLU </span>
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            Expiration_Table pd <span style='color:#800000; font-weight:bold; '>ON</span> pd<span style='color:#808030; '>.</span>JnlTicketID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#800000; font-weight:bold; '>AND</span> pd<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID 
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            <span style='color:#808030; '>#</span>temp_item_view_sp iv <span style='color:#800000; font-weight:bold; '>ON</span> tk<span style='color:#808030; '>.</span>PLU <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>PLU        
        <span style='color:#800000; font-weight:bold; '>WHERE</span>
            tk<span style='color:#808030; '>.</span>Status <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span>     <span style='color:#696969; '>-- valid + sold but not activated tickets</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> tk<span style='color:#808030; '>.</span>NodeNo <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> NodeNo <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#797997; '>@excludeNodes</span><span style='color:#808030; '>)</span> <span style='color:#696969; '>--testing</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> tk<span style='color:#808030; '>.</span>AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>10000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>30002</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#797997; '>@StartCutoffDateTime</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#797997; '>@CutoffDateTime</span> 
        
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@tickettot</span> <span style='color:#800000; font-weight:bold; '>INT</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>COUNT</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    found ['</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@tickettot</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>']'</span><span style='color:#808030; '>;</span>   
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  populating temp table with Passes'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Insert all valid passes in our temp table</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span>
            <span style='color:#808030; '>#</span>temp_item_sp
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span>NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>108</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            BusinessDate <span style='color:#808030; '>=</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>DateSold<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>PassNo<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>NodeNo<span style='color:#808030; '>,</span>
            UserId <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>AccessCode<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>ValidFrom<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>Status<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>Price<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>PLU<span style='color:#808030; '>,</span>
            pa<span style='color:#808030; '>.</span>Company<span style='color:#808030; '>,</span>     <span style='color:#696969; '>-- maybe?</span>
            pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            RevRule <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevRule<span style='color:#808030; '>,</span>
            GalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RevNumVisits <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevNumVisits<span style='color:#808030; '>,</span>
            MaxNumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
            NumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            Channel <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RemValue <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            ValidFrom <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            ValidTo <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            DefRevenue <span style='color:#808030; '>=</span> <span style='color:#008000; '>0.00</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span>
            JnlHeaders jh 
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlDetails jd <span style='color:#800000; font-weight:bold; '>ON</span> jh<span style='color:#808030; '>.</span>JnlTranID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlTranID 
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlTickets jt <span style='color:#800000; font-weight:bold; '>ON</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlDetailID  
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            Passes pa <span style='color:#800000; font-weight:bold; '>ON</span> pa<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID <span style='color:#696969; '>--AND pa.PLU = jt.PLU </span>
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            Expiration_Table pd <span style='color:#800000; font-weight:bold; '>ON</span> pd<span style='color:#808030; '>.</span>JnlTicketID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#800000; font-weight:bold; '>AND</span> pd<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID    
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            <span style='color:#808030; '>#</span>temp_item_view_sp iv <span style='color:#800000; font-weight:bold; '>ON</span> pa<span style='color:#808030; '>.</span>PLU <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>PLU        
        <span style='color:#800000; font-weight:bold; '>WHERE</span>
            pa<span style='color:#808030; '>.</span>Status <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>                        <span style='color:#696969; '>-- valid</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> pa<span style='color:#808030; '>.</span>NodeNo <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> NodeNo <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#797997; '>@excludeNodes</span><span style='color:#808030; '>)</span>  <span style='color:#696969; '>--testing</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> pa<span style='color:#808030; '>.</span>AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>20000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>90000</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> USER02 <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>''</span> <span style='color:#800000; font-weight:bold; '>AND</span> USER10 <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>''</span> 
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#797997; '>@StartCutoffDateTime</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#797997; '>@CutoffDateTime</span>  
        
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@passestot</span> <span style='color:#800000; font-weight:bold; '>INT</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>COUNT</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>)</span> <span style='color:#808030; '>-</span> <span style='color:#797997; '>@tickettot</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    found ['</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@passestot</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>']'</span><span style='color:#808030; '>;</span>   
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  populating temp table with SuperTickets'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Insert miscellaneous passes in our temp table, such as renewed, reissue, replaced, etc</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span>
            <span style='color:#808030; '>#</span>temp_item_sp
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DATE</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span>NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>108</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            BusinessDate <span style='color:#808030; '>=</span> <span style='color:#797997; '>@BusinessDateTime</span><span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>DateSold<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>JnlTicketID<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>NodeNo<span style='color:#808030; '>,</span>
            UserId <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>AccessCode<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>DateSold<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>Status<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>Price<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>PLU<span style='color:#808030; '>,</span>
            jt<span style='color:#808030; '>.</span>CustomerID<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            RevRule <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevRule<span style='color:#808030; '>,</span>
            GalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RevNumVisits <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>RevNumVisits<span style='color:#808030; '>,</span>
            MaxNumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
            NumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            Channel <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            RemValue <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
            ValidFrom <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidFromDate<span style='color:#808030; '>,</span>
            ValidTo <span style='color:#808030; '>=</span> pd<span style='color:#808030; '>.</span>ValidToDate<span style='color:#808030; '>,</span>
            DefRevenue <span style='color:#808030; '>=</span> <span style='color:#008000; '>0.00</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span>
            JnlHeaders jh  
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlDetails jd <span style='color:#800000; font-weight:bold; '>ON</span> jh<span style='color:#808030; '>.</span>JnlTranID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlTranID  
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            JnlTickets jt <span style='color:#800000; font-weight:bold; '>ON</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlDetailID  
        <span style='color:#800000; font-weight:bold; '>JOIN</span>
            SuperTickets st <span style='color:#800000; font-weight:bold; '>ON</span> st<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID  
        <span style='color:#800000; font-weight:bold; '>JOIN</span> 
            Expiration_Table pd <span style='color:#800000; font-weight:bold; '>ON</span> pd<span style='color:#808030; '>.</span>JnlTicketID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#800000; font-weight:bold; '>AND</span> pd<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID
        <span style='color:#800000; font-weight:bold; '>JOIN</span> 
            <span style='color:#808030; '>#</span>temp_item_view_sp iv <span style='color:#800000; font-weight:bold; '>ON</span> jt<span style='color:#808030; '>.</span>PLU <span style='color:#808030; '>=</span> iv<span style='color:#808030; '>.</span>PLU    
        <span style='color:#800000; font-weight:bold; '>WHERE</span> 
            st<span style='color:#808030; '>.</span>VisualID <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> VisualID <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>)</span> <span style='color:#696969; '>-- exclude duplicate in tickets/passes table</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> jt<span style='color:#808030; '>.</span>Status <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>                            <span style='color:#696969; '>-- valid</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> jt<span style='color:#808030; '>.</span>Qty <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>                                  <span style='color:#696969; '>-- current</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> jt<span style='color:#808030; '>.</span>AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>80000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>90000</span>       <span style='color:#696969; '>-- only passes</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> jt<span style='color:#808030; '>.</span>NodeNo <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> NodeNo <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#797997; '>@excludeNodes</span><span style='color:#808030; '>)</span>  <span style='color:#696969; '>--testing</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> jt<span style='color:#808030; '>.</span>TktCode <span style='color:#808030; '>&lt;</span> <span style='color:#008c00; '>40000</span>                          <span style='color:#696969; '>-- non lost/reissue  --filter with lost/reissue fees</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> st<span style='color:#808030; '>.</span>NextID <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>AND</span> st<span style='color:#808030; '>.</span>Status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>3</span> <span style='color:#800000; font-weight:bold; '>AND</span> st<span style='color:#808030; '>.</span>TicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>AND</span> st<span style='color:#808030; '>.</span>CurrentRecord <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>      <span style='color:#696969; '>-- old but valid ticket</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span><span style='color:#808030; '>=</span> <span style='color:#797997; '>@StartCutoffDateTime</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>jh<span style='color:#808030; '>.</span>TranDate<span style='color:#808030; '>,</span><span style='color:#008c00; '>120</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span> <span style='color:#797997; '>@CutoffDateTime</span> 
        
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@supertiktot</span> <span style='color:#800000; font-weight:bold; '>INT</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>COUNT</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>)</span> <span style='color:#808030; '>-</span> <span style='color:#797997; '>@tickettot</span> <span style='color:#808030; '>-</span> <span style='color:#797997; '>@passestot</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':    found ['</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@supertiktot</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>']'</span><span style='color:#808030; '>;</span> 
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Loop through all items and adjust usage, rules, dates, revenue, etc</span>
        <span style='color:#800000; font-weight:bold; '>DECLARE</span> <span style='color:#797997; '>@max</span> <span style='color:#800000; font-weight:bold; '>INT</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>count</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  found total ['</span> <span style='color:#808030; '>+</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@max</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>'] items'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  looping through and calculating Deferred Revenue...'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  Started new Logic calculation...'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>CREATE</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#808030; '>(</span>
            iVisualID           NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span>    <span style='color:#808030; '>,</span>
            iVisualIDInt        <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iUserID             <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iCustomerID         <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iIsWholeSaler       <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iGalaxyRule         <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iMaxNumUsage        <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iNumUsage           <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iChannel            <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iRemValue           <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iAccessCode         <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iPLU                NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>20</span><span style='color:#808030; '>)</span>    <span style='color:#808030; '>,</span>
            iRevRule            NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>   <span style='color:#808030; '>,</span>
            iRevNumVisits       NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span>   <span style='color:#808030; '>,</span>
            iTransDate          DATETIME        <span style='color:#808030; '>,</span>
            iIssueDate          DATETIME        <span style='color:#808030; '>,</span>
            iValidFrom          DATETIME        <span style='color:#808030; '>,</span>
            iValidFromAdj       DATETIME        <span style='color:#808030; '>,</span>
            iValidTo            DATETIME        <span style='color:#808030; '>,</span>
            iPrice              <span style='color:#800000; font-weight:bold; '>DECIMAL</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span>  <span style='color:#808030; '>,</span>
            iDefRevenue         <span style='color:#800000; font-weight:bold; '>DECIMAL</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>18</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span>  <span style='color:#808030; '>,</span>
            iSuperTicketIDF     <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iNextIDF            <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iVisualIDF          NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span>    <span style='color:#808030; '>,</span>
            iVisualIDFF         NVARCHAR<span style='color:#808030; '>(</span><span style='color:#008c00; '>40</span><span style='color:#808030; '>)</span>    <span style='color:#808030; '>,</span>
            iBaseIDF            <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iAuxIDF             <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iStatusF            <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iTicketTypeF        <span style='color:#800000; font-weight:bold; '>INT</span>             <span style='color:#808030; '>,</span>
            iCurrentRecordF     <span style='color:#800000; font-weight:bold; '>BIT</span>             <span style='color:#808030; '>,</span>
            iTotalUsageF        <span style='color:#800000; font-weight:bold; '>INT</span> 
        <span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting Inserting into TempTable '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>INSERT</span> <span style='color:#800000; font-weight:bold; '>INTO</span>  <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#808030; '>(</span>iVisualID<span style='color:#808030; '>,</span> iAccessCode<span style='color:#808030; '>,</span> iCustomerID<span style='color:#808030; '>,</span>iIssueDate<span style='color:#808030; '>,</span> iPrice<span style='color:#808030; '>,</span> iRevRule<span style='color:#808030; '>,</span> iRevNumVisits<span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>,</span> iIsWholeSaler
        <span style='color:#808030; '>,</span>iNumUsage<span style='color:#808030; '>,</span> iChannel<span style='color:#808030; '>,</span> iMaxNumUsage<span style='color:#808030; '>,</span> iGalaxyRule<span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
                VisualID<span style='color:#808030; '>,</span>
                AccessCode<span style='color:#808030; '>,</span>
                <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>CustomerID<span style='color:#808030; '>,</span>
                IssueDate<span style='color:#808030; '>,</span>
                Price<span style='color:#808030; '>,</span>
                RevRule<span style='color:#808030; '>,</span>
                RevNumVisits<span style='color:#808030; '>,</span>
                <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> ValidFrom <span style='color:#800000; font-weight:bold; '>is</span> <span style='color:#800000; font-weight:bold; '>null</span> <span style='color:#800000; font-weight:bold; '>then</span> IssueDate  <span style='color:#696969; '>-- if ValidFrom is NULL or > ValidTo, use IssueDate</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> ValidFrom <span style='color:#808030; '>></span> ValidTo <span style='color:#800000; font-weight:bold; '>then</span> IssueDate
                     <span style='color:#800000; font-weight:bold; '>else</span> ValidFrom <span style='color:#800000; font-weight:bold; '>end</span> <span style='color:#800000; font-weight:bold; '>as</span> iValidFrom<span style='color:#808030; '>,</span>
                ValidTo<span style='color:#808030; '>,</span>
                <span style='color:#bb7977; font-weight:bold; '>ISNULL</span><span style='color:#808030; '>(</span>autotable<span style='color:#808030; '>.</span>CountRows<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>  <span style='color:#696969; '>--check with the wholesalers flag which sell from wholesaler</span>
                <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span><span style='color:#696969; '>--dbo.gtsf_interface_sap_usage_sp_temp(VisualID),</span>
                <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> autotable<span style='color:#808030; '>.</span>CountRows <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>end</span> <span style='color:#800000; font-weight:bold; '>as</span>  iChannel<span style='color:#808030; '>,</span>  <span style='color:#696969; '>--check with the channel flag which sales channel</span>
                <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> isnumeric<span style='color:#808030; '>(</span>RevNumVisits<span style='color:#808030; '>)</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>INT</span><span style='color:#808030; '>,</span> RevNumVisits<span style='color:#808030; '>)</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> RevNumVisits  <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'UNLIMITED'</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>365</span> 
                     <span style='color:#800000; font-weight:bold; '>ELSE</span> <span style='color:#008c00; '>1</span>
                <span style='color:#800000; font-weight:bold; '>end</span> <span style='color:#800000; font-weight:bold; '>as</span> iMaxNumUsage<span style='color:#808030; '>,</span>
                <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> RevRule <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'10'</span>    <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>4</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> RevRule <span style='color:#800000; font-weight:bold; '>in</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'1'</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'5'</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'6'</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>1</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> RevRule <span style='color:#800000; font-weight:bold; '>in</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'2'</span> <span style='color:#808030; '>,</span><span style='color:#0000e6; '>'3'</span> <span style='color:#808030; '>,</span><span style='color:#0000e6; '>'4'</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>2</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> RevRule <span style='color:#800000; font-weight:bold; '>in</span> <span style='color:#808030; '>(</span> <span style='color:#0000e6; '>'7'</span> <span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'8'</span> <span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'9'</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>3</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span>  <span style='color:#008c00; '>10000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>20000</span> <span style='color:#800000; font-weight:bold; '>then</span>  <span style='color:#008c00; '>1</span>
                     <span style='color:#800000; font-weight:bold; '>when</span> AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>20000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>30000</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>2</span>                             
                     <span style='color:#800000; font-weight:bold; '>when</span> AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>80000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>90000</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>3</span> 
                     <span style='color:#800000; font-weight:bold; '>when</span> AccessCode <span style='color:#800000; font-weight:bold; '>BETWEEN</span> <span style='color:#008c00; '>30000</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#008c00; '>30002</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>4</span>                                                                     
                    <span style='color:#800000; font-weight:bold; '>END</span> <span style='color:#800000; font-weight:bold; '>as</span> GalaxyRule
        <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_sp <span style='color:#800000; font-weight:bold; '>temp</span> 
        <span style='color:#800000; font-weight:bold; '>left</span> <span style='color:#800000; font-weight:bold; '>join</span>
        <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> CustomerID<span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>COUNT</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>as</span> CountRows <span style='color:#800000; font-weight:bold; '>FROM</span> gtsv_interface_sap_wholesale_sp <span style='color:#800000; font-weight:bold; '>group</span> <span style='color:#800000; font-weight:bold; '>by</span> CustomerID <span style='color:#808030; '>)</span> autotable
        <span style='color:#800000; font-weight:bold; '>on</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>CustomerID <span style='color:#808030; '>=</span> autotable<span style='color:#808030; '>.</span>CustomerID
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Finished Inserting into TempTable '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Updating iNumUsage into TempTable '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>--update #temp_item_view_sp_table</span>
        <span style='color:#696969; '>--set iNumUsage = dbo.gtsf_interface_sap_usage_sp_temp(iVisualID);</span>
        <span style='color:#800000; font-weight:bold; '>WITH</span> CTE <span style='color:#800000; font-weight:bold; '>as</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>Select</span> SuperTicketID<span style='color:#808030; '>,</span> BaseID <span style='color:#808030; '>,</span>VisualID <span style='color:#808030; '>,</span>ROW_NUMBER<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>OVER</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>Partition</span> <span style='color:#800000; font-weight:bold; '>by</span> VisualID <span style='color:#800000; font-weight:bold; '>order</span> <span style='color:#800000; font-weight:bold; '>by</span> VisualID<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>as</span> <span style='color:#800000; font-weight:bold; '>rownum</span>
                    <span style='color:#800000; font-weight:bold; '>from</span>  gtsv_interface_sap_super_sp <span style='color:#800000; font-weight:bold; '>a</span> <span style='color:#800000; font-weight:bold; '>where</span> CurrentRecord <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>
            <span style='color:#808030; '>,</span>CTE_Base <span style='color:#800000; font-weight:bold; '>as</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>Select</span> b<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>,</span> CTE<span style='color:#808030; '>.</span>VisualID <span style='color:#800000; font-weight:bold; '>as</span> cte_VisualId <span style='color:#800000; font-weight:bold; '>from</span> gtsv_interface_sap_super_sp b <span style='color:#800000; font-weight:bold; '>inner</span> <span style='color:#800000; font-weight:bold; '>join</span> CTE <span style='color:#800000; font-weight:bold; '>on</span> CTE<span style='color:#808030; '>.</span>BaseID <span style='color:#808030; '>=</span> b<span style='color:#808030; '>.</span>BaseID <span style='color:#800000; font-weight:bold; '>where</span> CTE<span style='color:#808030; '>.</span><span style='color:#800000; font-weight:bold; '>rownum</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span>
            <span style='color:#808030; '>,</span>CTE_Count <span style='color:#800000; font-weight:bold; '>as</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>select</span> CTE_Base<span style='color:#808030; '>.</span>cte_VisualId<span style='color:#808030; '>,</span><span style='color:#bb7977; font-weight:bold; '>count</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>as</span> numUsage <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#800000; font-weight:bold; '>Usage</span> u <span style='color:#800000; font-weight:bold; '>inner</span> <span style='color:#800000; font-weight:bold; '>join</span> CTE_Base <span style='color:#800000; font-weight:bold; '>on</span> u<span style='color:#808030; '>.</span>ScannedVisualID <span style='color:#808030; '>=</span> CTE_Base<span style='color:#808030; '>.</span>VisualID 
                            <span style='color:#800000; font-weight:bold; '>where</span> u<span style='color:#808030; '>.</span>Code<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>and</span> u<span style='color:#808030; '>.</span>Status<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>group</span> <span style='color:#800000; font-weight:bold; '>by</span> CTE_Base<span style='color:#808030; '>.</span>cte_VisualId
                            <span style='color:#800000; font-weight:bold; '>union</span> 
                            <span style='color:#800000; font-weight:bold; '>select</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID<span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>count</span><span style='color:#808030; '>(</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>as</span> numUsage  <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#800000; font-weight:bold; '>Usage</span> u <span style='color:#800000; font-weight:bold; '>inner</span> <span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span> <span style='color:#800000; font-weight:bold; '>on</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> u<span style='color:#808030; '>.</span>ScannedVisualID 
                            <span style='color:#800000; font-weight:bold; '>where</span> u<span style='color:#808030; '>.</span>Code<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>and</span> u<span style='color:#808030; '>.</span>Status<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>group</span> <span style='color:#800000; font-weight:bold; '>by</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID<span style='color:#808030; '>)</span>
            <span style='color:#808030; '>,</span>CTE_Agg <span style='color:#800000; font-weight:bold; '>as</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#bb7977; font-weight:bold; '>sum</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>c</span><span style='color:#808030; '>.</span>numUsage<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>as</span> numUsage<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>c</span><span style='color:#808030; '>.</span>cte_VisualId <span style='color:#800000; font-weight:bold; '>from</span> CTE_Count <span style='color:#800000; font-weight:bold; '>c</span> <span style='color:#800000; font-weight:bold; '>group</span> <span style='color:#800000; font-weight:bold; '>by</span> <span style='color:#800000; font-weight:bold; '>c</span><span style='color:#808030; '>.</span>cte_VisualId<span style='color:#808030; '>)</span>

        <span style='color:#800000; font-weight:bold; '>Update</span> <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>set</span> iNumUsage<span style='color:#808030; '>=</span>CTE_Agg<span style='color:#808030; '>.</span>numUsage
        <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span> 
        <span style='color:#800000; font-weight:bold; '>inner</span> <span style='color:#800000; font-weight:bold; '>join</span> CTE_Agg <span style='color:#800000; font-weight:bold; '>on</span> CTE_Agg<span style='color:#808030; '>.</span>cte_VisualId<span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Update Finished iNumUsage into TempTable '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Adjust calculation</span>
        <span style='color:#696969; '>-- recalculate expiration date</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting Adjusting calculation '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iValidTo <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> iGalaxyRule <span style='color:#800000; font-weight:bold; '>in</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#bb7977; font-weight:bold; '>ISNULL</span><span style='color:#808030; '>(</span>iValidTo<span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>MONTH</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>6</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
                            <span style='color:#800000; font-weight:bold; '>when</span> iGalaxyRule <span style='color:#808030; '>=</span><span style='color:#008c00; '>3</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#bb7977; font-weight:bold; '>ISNULL</span><span style='color:#808030; '>(</span>iValidTo<span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>YEAR</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>  <span style='color:#696969; '>-- for MA, add 1 year if null, for 2 year need review</span>
                            <span style='color:#800000; font-weight:bold; '>when</span> iGalaxyRule <span style='color:#808030; '>=</span><span style='color:#008c00; '>4</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#bb7977; font-weight:bold; '>ISNULL</span><span style='color:#808030; '>(</span>iValidTo<span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>MONTH</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
                            <span style='color:#800000; font-weight:bold; '>end</span><span style='color:#808030; '>,</span>
            iRemValue <span style='color:#808030; '>=</span> iMaxNumUsage <span style='color:#808030; '>-</span> iNumUsage<span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished Adjusting calculation '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>
        <span style='color:#696969; '>-- POST-process: calculate deferred revenue </span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting calculate deferred revenue '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iDefRevenue <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> iMaxNumUsage<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#808030; '>(</span>iPrice <span style='color:#808030; '>*</span> iRemValue<span style='color:#808030; '>)</span> <span style='color:#808030; '>/</span> iMaxNumUsage <span style='color:#800000; font-weight:bold; '>end</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished calculate deferred revenue'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- calculate amortization</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting calculate amortization '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iRemValue <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span> iValidFrom <span style='color:#808030; '>></span> <span style='color:#797997; '>@ExpirationDate</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> 
                             <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>end</span>
        <span style='color:#800000; font-weight:bold; '>where</span> iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>3</span> <span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iDefRevenue <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span>  <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> <span style='color:#808030; '>></span>  <span style='color:#008c00; '>0</span>  
                                    <span style='color:#800000; font-weight:bold; '>then</span> iPrice <span style='color:#808030; '>/</span> <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> iRemValue <span style='color:#800000; font-weight:bold; '>end</span>
        <span style='color:#800000; font-weight:bold; '>where</span> iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>3</span> <span style='color:#800000; font-weight:bold; '>and</span> iValidFrom <span style='color:#808030; '>></span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished calculate amortization'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting calculate deferred revenue '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>--@iValidFromAdj need to check if we are exporting it or not</span>
        <span style='color:#696969; '>-- adjust for 1st day: start deferred on 1st day</span>
        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iDefRevenue <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>CASE</span> <span style='color:#800000; font-weight:bold; '>when</span>  <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> <span style='color:#808030; '>></span>  <span style='color:#008c00; '>0</span>  
                                    <span style='color:#800000; font-weight:bold; '>then</span> iPrice <span style='color:#808030; '>/</span> <span style='color:#bb7977; font-weight:bold; '>DATEDIFF</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>DAY</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> iValidFrom<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> iRemValue <span style='color:#800000; font-weight:bold; '>end</span>
        <span style='color:#800000; font-weight:bold; '>where</span> iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>3</span> <span style='color:#800000; font-weight:bold; '>and</span> iValidFrom <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished calculate deferred revenue '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- adjust for expired + wholesaler tickets, ticket swap</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting calculate galaxy rule'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table
        <span style='color:#800000; font-weight:bold; '>set</span> iGalaxyRule<span style='color:#808030; '>=</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>,</span>
            iValidTo <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DATEADD</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>MONTH</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>5</span><span style='color:#808030; '>,</span> iValidTo<span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>where</span> iIsWholeSaler <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>AND</span> iNumUsage <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>AND</span> iValidTo <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> <span style='color:#797997; '>@ExpirationDate</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished calculate galaxy rule '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- write fucntion to see if ticket was upgraded, suggestion from Matt to check SuperTickets</span>
        <span style='color:#696969; '>-- get current/new ticket</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting calculate def revenue '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>set</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>case</span> <span style='color:#800000; font-weight:bold; '>when</span> autoTable<span style='color:#808030; '>.</span>currentTicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>and</span> autoTable<span style='color:#808030; '>.</span>previousTicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>7</span>
                                    <span style='color:#800000; font-weight:bold; '>when</span> autoTable<span style='color:#808030; '>.</span>currentTicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>and</span> autoTable<span style='color:#808030; '>.</span>previousTicketType <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>6</span>
                                    <span style='color:#800000; font-weight:bold; '>when</span> autoTable<span style='color:#808030; '>.</span>currentTicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>and</span> autoTable<span style='color:#808030; '>.</span>previousTicketType <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>then</span> <span style='color:#008c00; '>8</span>
                                    <span style='color:#800000; font-weight:bold; '>else</span> iGalaxyRule
                               <span style='color:#800000; font-weight:bold; '>end</span>
        <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#808030; '>(</span>
        <span style='color:#800000; font-weight:bold; '>SELECT</span>  <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID<span style='color:#808030; '>,</span>
                currentTicket<span style='color:#808030; '>.</span>BaseID <span style='color:#800000; font-weight:bold; '>as</span> currentBaseId<span style='color:#808030; '>,</span>
                currentTicket<span style='color:#808030; '>.</span>TicketType <span style='color:#800000; font-weight:bold; '>as</span> currentTicketType<span style='color:#808030; '>,</span>
                previousTicket<span style='color:#808030; '>.</span>TicketType <span style='color:#800000; font-weight:bold; '>as</span> previousTicketType<span style='color:#808030; '>,</span>
                ROW_NUMBER<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>OVER</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>Partition</span> <span style='color:#800000; font-weight:bold; '>by</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iCustomerID<span style='color:#808030; '>,</span> currentTicket<span style='color:#808030; '>.</span>BaseId <span style='color:#800000; font-weight:bold; '>order</span> <span style='color:#800000; font-weight:bold; '>by</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iCustomerID<span style='color:#808030; '>,</span> currentTicket<span style='color:#808030; '>.</span>BaseId<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>as</span> <span style='color:#800000; font-weight:bold; '>rownum</span>
        <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span> 
        <span style='color:#800000; font-weight:bold; '>join</span> gtsv_interface_sap_super_sp currentTicket <span style='color:#800000; font-weight:bold; '>on</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> currentTicket<span style='color:#808030; '>.</span>VisualID <span style='color:#800000; font-weight:bold; '>and</span> currentTicket<span style='color:#808030; '>.</span>CurrentRecord <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>
        <span style='color:#800000; font-weight:bold; '>join</span> gtsv_interface_sap_super_sp previousTicket <span style='color:#800000; font-weight:bold; '>on</span> previousTicket<span style='color:#808030; '>.</span>SuperTicketID <span style='color:#808030; '>=</span> currentTicket<span style='color:#808030; '>.</span>BaseID <span style='color:#800000; font-weight:bold; '>and</span> previousTicket<span style='color:#808030; '>.</span>Status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>4</span><span style='color:#808030; '>)</span> autoTable
        <span style='color:#800000; font-weight:bold; '>on</span> autoTable<span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID 
        <span style='color:#800000; font-weight:bold; '>where</span> autoTable<span style='color:#808030; '>.</span><span style='color:#800000; font-weight:bold; '>rownum</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished calculate def revenue '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- set multi-day ticket in passes to use GalaxyRule 2</span>
        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>set</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>2</span>
        <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>join</span> Passes pa <span style='color:#800000; font-weight:bold; '>on</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> pa<span style='color:#808030; '>.</span>VisualID
        <span style='color:#800000; font-weight:bold; '>where</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iRevRule <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'2'</span> <span style='color:#800000; font-weight:bold; '>and</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iGalaxyRule <span style='color:#808030; '>=</span> <span style='color:#008c00; '>6</span> <span style='color:#800000; font-weight:bold; '>and</span> pa<span style='color:#808030; '>.</span>Status <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>and</span> pa<span style='color:#808030; '>.</span>Kind <span style='color:#808030; '>=</span> <span style='color:#008c00; '>10</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': finished adjusting Multi-Day galaxy rule '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting get transaction date '</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- get transaction start date, for day end calculation</span>
        <span style='color:#800000; font-weight:bold; '>update</span> <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>set</span> iTransDate <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>ISNULL</span><span style='color:#808030; '>(</span>autotable<span style='color:#808030; '>.</span>TransStartDateTime<span style='color:#808030; '>,</span> iIssueDate<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
            iUserID <span style='color:#808030; '>=</span> autotable<span style='color:#808030; '>.</span>UserId  
        <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span> 
        <span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>select</span> <span style='color:#800000; font-weight:bold; '>ti</span><span style='color:#808030; '>.</span>iVisualID<span style='color:#808030; '>,</span> jh<span style='color:#808030; '>.</span>TransStartDateTime<span style='color:#808030; '>,</span> jh<span style='color:#808030; '>.</span>UserId
        <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>ti</span>
        <span style='color:#800000; font-weight:bold; '>JOIN</span> JnlTickets jt <span style='color:#800000; font-weight:bold; '>ON</span> <span style='color:#800000; font-weight:bold; '>ti</span><span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> jt<span style='color:#808030; '>.</span>VisualID
        <span style='color:#800000; font-weight:bold; '>JOIN</span> JnlDetails jd <span style='color:#800000; font-weight:bold; '>ON</span> jt<span style='color:#808030; '>.</span>JnlDetailID <span style='color:#808030; '>=</span> jd<span style='color:#808030; '>.</span>JnlDetailID
        <span style='color:#800000; font-weight:bold; '>JOIN</span> JnlHeaders jh <span style='color:#800000; font-weight:bold; '>ON</span> jd<span style='color:#808030; '>.</span>JnlTranID <span style='color:#808030; '>=</span> jh<span style='color:#808030; '>.</span>JnlTranID<span style='color:#808030; '>)</span> autotable
        <span style='color:#800000; font-weight:bold; '>on</span> autotable<span style='color:#808030; '>.</span>iVisualID <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID 

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': Starting updating temp table'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>
        <span style='color:#696969; '>-- update temps table with new calculated values</span>
    
        <span style='color:#800000; font-weight:bold; '>UPDATE</span> <span style='color:#800000; font-weight:bold; '>ti</span>
        <span style='color:#800000; font-weight:bold; '>SET</span> 
                    TransDate <span style='color:#808030; '>=</span> iTransDate<span style='color:#808030; '>,</span>
                    UserId <span style='color:#808030; '>=</span> iUserID<span style='color:#808030; '>,</span>
                    NumUsage <span style='color:#808030; '>=</span> iNumUsage<span style='color:#808030; '>,</span>
                    RemValue <span style='color:#808030; '>=</span> iRemValue<span style='color:#808030; '>,</span>
                    GalaxyRule <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>isnull</span><span style='color:#808030; '>(</span>iGalaxyRule<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
                    MaxNumUsage <span style='color:#808030; '>=</span> iMaxNumUsage<span style='color:#808030; '>,</span>
                    ValidFrom <span style='color:#808030; '>=</span> iValidFrom<span style='color:#808030; '>,</span>
                    ValidTo <span style='color:#808030; '>=</span> iValidTo<span style='color:#808030; '>,</span>
                    Channel <span style='color:#808030; '>=</span> iChannel<span style='color:#808030; '>,</span>
                    DefRevenue <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>isnull</span><span style='color:#808030; '>(</span>iDefRevenue<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
        <span style='color:#800000; font-weight:bold; '>from</span> <span style='color:#808030; '>#</span>temp_item_sp <span style='color:#800000; font-weight:bold; '>ti</span>
        <span style='color:#800000; font-weight:bold; '>inner</span> <span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#808030; '>#</span>temp_item_view_sp_table <span style='color:#800000; font-weight:bold; '>temp</span>
        <span style='color:#800000; font-weight:bold; '>on</span> <span style='color:#800000; font-weight:bold; '>ti</span><span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>temp</span><span style='color:#808030; '>.</span>iVisualID 

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  Finished new Logic calculation...'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>RAISERROR</span><span style='color:#808030; '>(</span>N<span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>WITH</span> <span style='color:#800000; font-weight:bold; '>NOWAIT</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  storing result to [gtsd_sap_export_logs] table'</span><span style='color:#808030; '>;</span>

        <span style='color:#696969; '>-- Insert statements for procedure here</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span>
            gtsd_sap_export_logs
        <span style='color:#800000; font-weight:bold; '>SELECT</span>
            ExportDate<span style='color:#808030; '>,</span> ExportTime<span style='color:#808030; '>,</span> BusinessDate<span style='color:#808030; '>,</span> it<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>,</span> it<span style='color:#808030; '>.</span>AccessCode<span style='color:#808030; '>,</span> ValidFrom<span style='color:#808030; '>,</span> ValidTo<span style='color:#808030; '>,</span> 
            RevRule<span style='color:#808030; '>,</span> GalaxyRule<span style='color:#808030; '>,</span> Channel<span style='color:#808030; '>,</span> RemValue<span style='color:#808030; '>,</span> it<span style='color:#808030; '>.</span>Price<span style='color:#808030; '>,</span> it<span style='color:#808030; '>.</span>PLU<span style='color:#808030; '>,</span> DefRevenue
        <span style='color:#800000; font-weight:bold; '>FROM</span> 
            <span style='color:#808030; '>#</span>temp_item_sp it
        <span style='color:#696969; '>--JOIN JnlTickets jt ON it.VisualID = jt.VisualID</span>
        <span style='color:#696969; '>--JOIN JnlDetails jd ON jt.JnlDetailID = jd.JnlDetailID</span>
        <span style='color:#696969; '>--JOIN JnlHeaders jh ON jd.JnlTranID = jh.JnlTranID</span>
        <span style='color:#800000; font-weight:bold; '>WHERE</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>=</span><span style='color:#008c00; '>1</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>
                   <span style='color:#808030; '>(</span><span style='color:#797997; '>@GalaxyRule</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>GalaxyRule <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>)</span>             <span style='color:#696969; '>-- all</span>
                <span style='color:#800000; font-weight:bold; '>OR</span> <span style='color:#808030; '>(</span><span style='color:#797997; '>@GalaxyRule</span> <span style='color:#808030; '>=</span> it<span style='color:#808030; '>.</span>GalaxyRule <span style='color:#808030; '>)</span>                       <span style='color:#696969; '>-- by specific rules</span>
            <span style='color:#808030; '>)</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>Status <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span>                                     <span style='color:#696969; '>-- valid + sold but not activated tickets</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>RemValue <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span>                                         <span style='color:#696969; '>-- unused</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>ValidTo <span style='color:#808030; '>></span> <span style='color:#797997; '>@ExpirationDate</span>                            <span style='color:#696969; '>-- unexpired</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>TransDate <span style='color:#808030; '>&lt;</span> <span style='color:#797997; '>@CutoffDateTime</span>                          <span style='color:#696969; '>-- consider only data made before 3:30am</span>
            <span style='color:#800000; font-weight:bold; '>AND</span> it<span style='color:#808030; '>.</span>UserId <span style='color:#800000; font-weight:bold; '>NOT</span> <span style='color:#800000; font-weight:bold; '>IN</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>SELECT</span> UserId <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#797997; '>@excludeUsers</span><span style='color:#808030; '>)</span>     <span style='color:#696969; '>-- exlude ATS users</span>
        <span style='color:#696969; '>--GROUP BY</span>
        <span style='color:#696969; '>--  jt.VisualID, jd.JnlDetailID, jh.JnlTranID</span>
        <span style='color:#800000; font-weight:bold; '>ORDER</span> <span style='color:#800000; font-weight:bold; '>BY</span>
            it<span style='color:#808030; '>.</span>ItemID

        <span style='color:#696969; '>-- save copy to history table</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  archiving result to [gtsd_sap_export_hist] table'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>INSERT</span> <span style='color:#800000; font-weight:bold; '>INTO</span> gtsd_sap_export_hist <span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#808030; '>*</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_logs<span style='color:#808030; '>;</span>
                
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  returning result set to caller'</span><span style='color:#808030; '>;</span>
        <span style='color:#696969; '>-- return result set</span>
        <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#797997; '>@DebugFlag</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span>
            <span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#696969; '>/*DISTINCT*/</span> it<span style='color:#808030; '>.</span><span style='color:#808030; '>*</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_logs el <span style='color:#800000; font-weight:bold; '>JOIN</span> <span style='color:#808030; '>#</span>temp_item_sp it <span style='color:#800000; font-weight:bold; '>ON</span> el<span style='color:#808030; '>.</span>VisualID <span style='color:#808030; '>=</span> it<span style='color:#808030; '>.</span>VisualID<span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>ELSE</span>
            <span style='color:#800000; font-weight:bold; '>SELECT</span> <span style='color:#696969; '>/*DISTINCT*/</span> <span style='color:#808030; '>*</span> <span style='color:#800000; font-weight:bold; '>FROM</span> gtsd_sap_export_logs<span style='color:#808030; '>;</span>
            
    <span style='color:#e34adc; '>Finalize:</span>   <span style='color:#696969; '>-- label</span>
        <span style='color:#696969; '>-- clean up</span>
        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>':  cleaning up objects'</span><span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>DROP</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#800000; font-weight:bold; '>EXISTS</span> <span style='color:#808030; '>#</span>temp_item_sp<span style='color:#808030; '>;</span>
        <span style='color:#800000; font-weight:bold; '>DROP</span> <span style='color:#800000; font-weight:bold; '>TABLE</span> <span style='color:#800000; font-weight:bold; '>IF</span> <span style='color:#800000; font-weight:bold; '>EXISTS</span> <span style='color:#808030; '>#</span>temp_item_view_sp<span style='color:#808030; '>;</span>

        <span style='color:#800000; font-weight:bold; '>PRINT</span> <span style='color:#bb7977; font-weight:bold; '>CONVERT</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>VARCHAR</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#bb7977; font-weight:bold; '>GETDATE</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>121</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>+</span> <span style='color:#0000e6; '>': DONE.'</span>  
<span style='color:#800000; font-weight:bold; '>END</span>
</pre>
<!--Created using ToHtml.com on 2018-12-24 05:56:45 UTC -->