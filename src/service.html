<pre style='color:#000000;background:#ffffff;'><span style='color:#008000; '>// ==========================================================================</span>
<span style='color:#008000; '>// Author:  Yee Hsu</span>
<span style='color:#008000; '>// Date:    6/8/2007</span>
<span style='color:#008000; '>//</span>
<span style='color:#008000; '>// Desc:    Service Enumerator. Lists all the Windows services that are</span>
<span style='color:#008000; '>//          currently running.</span>
<span style='color:#008000; '>// ==========================================================================</span>

<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#0000e6; '>"</span><span style='color:#40015a; '>stdafx.h</span><span style='color:#0000e6; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#0000e6; '>"</span><span style='color:#40015a; '>CRegKey.h</span><span style='color:#0000e6; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#0000e6; '>"</span><span style='color:#40015a; '>MD5.h</span><span style='color:#0000e6; '>"</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; '>include </span><span style='color:#0000e6; '>"</span><span style='color:#40015a; '>IntCommon.h</span><span style='color:#0000e6; '>"</span>

<span style='color:#0000ff; font-weight:bold; '>bool</span> GetServList<span style='color:#0000ff; '>(</span>lServiceList<span style='color:#0000ff; '>&amp;</span> lServices<span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span> dwBytesNeeded         <span style='color:#0000ff; '>=</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span> dwServicesReturned    <span style='color:#0000ff; '>=</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span> dwResumedHandle       <span style='color:#0000ff; '>=</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>ENUM_SERVICE_STATUS</span> service<span style='color:#0000ff; '>;</span>

    ServiceBlock ServData<span style='color:#0000ff; '>;</span>

    <span style='color:#008000; '>// Opens a handle to the service manager</span>
    <span style='color:#0000ff; font-weight:bold; '>SC_HANDLE</span> hHandle <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>OpenSCManager</span><span style='color:#0000ff; '>(</span><span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> SC_MANAGER_ENUMERATE_SERVICE<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>!</span>hHandle<span style='color:#0000ff; '>)</span>
        <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>

    <span style='color:#008000; '>// Query services</span>
    <span style='color:#0000ff; font-weight:bold; '>BOOL</span> retVal <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>EnumServicesStatus</span><span style='color:#0000ff; '>(</span>hHandle<span style='color:#0000ff; '>,</span> SERVICE_WIN32 <span style='color:#0000ff; '>|</span> SERVICE_DRIVER<span style='color:#0000ff; '>,</span> SERVICE_STATE_ALL<span style='color:#0000ff; '>,</span> 
        <span style='color:#0000ff; '>&amp;</span>service<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>ENUM_SERVICE_STATUS</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>dwBytesNeeded<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>dwServicesReturned<span style='color:#0000ff; '>,</span>
        <span style='color:#0000ff; '>&amp;</span>dwResumedHandle<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>!</span>retVal<span style='color:#0000ff; '>)</span>
    <span style='color:#0000ff; '>{</span>
        <span style='color:#008000; '>// Set the buffer</span>
        <span style='color:#0000ff; font-weight:bold; '>DWORD</span> dwBytes <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>ENUM_SERVICE_STATUS</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>+</span> dwBytesNeeded<span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>ENUM_SERVICE_STATUS</span><span style='color:#0000ff; '>*</span> pServices <span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>;</span>
        pServices <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>new</span> <span style='color:#0000ff; font-weight:bold; '>ENUM_SERVICE_STATUS</span> <span style='color:#0000ff; '>[</span>dwBytes<span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span>

        <span style='color:#008000; '>// Now query again for services</span>
        <span style='color:#0000ff; font-weight:bold; '>EnumServicesStatus</span><span style='color:#0000ff; '>(</span>hHandle<span style='color:#0000ff; '>,</span> SERVICE_WIN32 <span style='color:#0000ff; '>|</span> SERVICE_DRIVER<span style='color:#0000ff; '>,</span> SERVICE_STATE_ALL<span style='color:#0000ff; '>,</span> 
            pServices<span style='color:#0000ff; '>,</span> dwBytes<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>dwBytesNeeded<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>dwServicesReturned<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>dwResumedHandle<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

        <span style='color:#008000; '>// now traverse and save each services in a structure</span>
        <span style='color:#0000ff; font-weight:bold; '>for</span> <span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>unsigned</span> iIndex <span style='color:#0000ff; '>=</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>;</span> iIndex <span style='color:#0000ff; '>&lt;</span> dwServicesReturned<span style='color:#0000ff; '>;</span> iIndex<span style='color:#0000ff; '>+</span><span style='color:#0000ff; '>+</span><span style='color:#0000ff; '>)</span>
        <span style='color:#0000ff; '>{</span>
            ServData<span style='color:#0000ff; '>.</span>sDisplayName <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>(</span>pServices <span style='color:#0000ff; '>+</span> iIndex<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#0000ff; '>></span>lpDisplayName<span style='color:#0000ff; '>;</span>
            ServData<span style='color:#0000ff; '>.</span>sServiceName <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>(</span>pServices <span style='color:#0000ff; '>+</span> iIndex<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#0000ff; '>></span>lpServiceName<span style='color:#0000ff; '>;</span>
            ServData<span style='color:#0000ff; '>.</span>sServiceStat <span style='color:#0000ff; '>=</span> GetCurrentStatus<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>(</span>pServices <span style='color:#0000ff; '>+</span> iIndex<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#0000ff; '>></span>ServiceStatus<span style='color:#0000ff; '>.</span>dwCurrentState<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            ServData<span style='color:#0000ff; '>.</span>sServiceType <span style='color:#0000ff; '>=</span> GetTypeOfService<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>(</span>pServices <span style='color:#0000ff; '>+</span> iIndex<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#0000ff; '>></span>ServiceStatus<span style='color:#0000ff; '>.</span>dwServiceType<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            
            GetServiceMD5andPath<span style='color:#0000ff; '>(</span>ServData<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            lServices<span style='color:#0000ff; '>.</span>push_back<span style='color:#0000ff; '>(</span>ServData<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

            <span style='color:#008000; '>//////////////////////////////////////////////////////////////////// FLUSH TO STDOUT for real time parsing</span>
            <span style='color:#0000ff; font-weight:bold; '>fprintf</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>stderr</span><span style='color:#0000ff; '>,</span> <span style='color:#0000e6; '>"</span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>,</span> ServData<span style='color:#0000ff; '>.</span>sServiceName<span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#008000; '>//////////////////////////////////////////////////////////////////////////////////////////////////////////    </span>
        <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>CloseServiceHandle</span><span style='color:#0000ff; '>(</span>hHandle<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#0000ff; font-weight:bold; '>void</span> GetServiceMD5andPath<span style='color:#0000ff; '>(</span>ServiceBlock<span style='color:#0000ff; '>&amp;</span> ServData<span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>TCHAR</span> strWindowsPath<span style='color:#0000ff; '>[</span>MAX_PATH<span style='color:#0000ff; '>+</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span>
    std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span> service_reg_path<span style='color:#0000ff; '>;</span>
    CRegKey test<span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>char</span> str_path<span style='color:#0000ff; '>[</span><span style='color:#800000; '>1200</span><span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>unsigned</span> <span style='color:#0000ff; font-weight:bold; '>long</span> str_path_size<span style='color:#0000ff; '>=</span><span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span>str_path<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
    std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span> objImagePath<span style='color:#0000ff; '>;</span>

    service_reg_path <span style='color:#0000ff; '>=</span>    <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>SYSTEM</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>CurrentControlSet</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>Services</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>
    service_reg_path <span style='color:#0000ff; '>+</span><span style='color:#0000ff; '>=</span>    ServData<span style='color:#0000ff; '>.</span>sServiceName<span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span>    test<span style='color:#0000ff; '>.</span>Open<span style='color:#0000ff; '>(</span><span style='color:#808080; font-weight:bold; '>HKEY_LOCAL_MACHINE</span><span style='color:#0000ff; '>,</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>LPCTSTR</span><span style='color:#0000ff; '>)</span>service_reg_path<span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span><span style='color:#808080; font-weight:bold; '>KEY_QUERY_VALUE</span><span style='color:#0000ff; '>|</span><span style='color:#808080; font-weight:bold; '>KEY_ENUMERATE_SUB_KEYS</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span><span style='color:#0000ff; '>)</span>
    <span style='color:#0000ff; '>{</span>
        <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> FindServiceImagePath<span style='color:#0000ff; '>(</span> test<span style='color:#0000ff; '>.</span>m_hKey<span style='color:#0000ff; '>,</span> objImagePath <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
        <span style='color:#0000ff; '>{</span>
            <span style='color:#0000ff; font-weight:bold; '>size_t</span> j <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#0000ff; font-weight:bold; '>find</span><span style='color:#0000ff; '>(</span><span style='color:#000080; '>'"'</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; font-weight:bold; '>while</span> <span style='color:#0000ff; '>(</span> j <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span> <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                objImagePath <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span>erase<span style='color:#0000ff; '>(</span>j<span style='color:#0000ff; '>,</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                j <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#0000ff; font-weight:bold; '>find</span><span style='color:#0000ff; '>(</span><span style='color:#000080; '>'"'</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; '>}</span>

            std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span><span style='color:#0000ff; '>::</span>size_type pos <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#0000ff; font-weight:bold; '>find</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>??</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span> pos <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span><span style='color:#0000ff; '>::</span><span style='color:#808080; font-weight:bold; '>npos</span> <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                objImagePath <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span>erase<span style='color:#0000ff; '>(</span>pos<span style='color:#0000ff; '>,</span><span style='color:#800000; '>4</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; '>}</span>

            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> 
                    <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; font-weight:bold; '>strcmp</span><span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span><span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>System32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>System32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>  <span style='color:#0000ff; '>|</span><span style='color:#0000ff; '>|</span>
                    <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; font-weight:bold; '>strcmp</span><span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span><span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>SYSTEM32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>SYSTEM32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>  <span style='color:#0000ff; '>|</span><span style='color:#0000ff; '>|</span>
                    <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; font-weight:bold; '>strcmp</span><span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span><span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>system32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>system32</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>GetWindowsDirectory</span><span style='color:#0000ff; '>(</span> strWindowsPath<span style='color:#0000ff; '>,</span> MAX_PATH <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                <span style='color:#0000ff; '>{</span>
                    objImagePath<span style='color:#0000ff; '>.</span>insert<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                    objImagePath<span style='color:#0000ff; '>.</span>insert<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span>strWindowsPath<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                <span style='color:#0000ff; '>}</span>
            <span style='color:#0000ff; '>}</span>
            <span style='color:#0000ff; font-weight:bold; '>else</span>
                <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; font-weight:bold; '>strcmp</span><span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span><span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>SystemRoot</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>SystemRoot</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                <span style='color:#0000ff; '>{</span>
                    <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>GetWindowsDirectory</span><span style='color:#0000ff; '>(</span> strWindowsPath<span style='color:#0000ff; '>,</span> MAX_PATH <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                    <span style='color:#0000ff; '>{</span>
                        objImagePath <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>SystemRoot</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span> <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                        objImagePath<span style='color:#0000ff; '>.</span>insert<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span>strWindowsPath<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                    <span style='color:#0000ff; '>}</span>
                <span style='color:#0000ff; '>}</span>

            <span style='color:#0000ff; font-weight:bold; '>size_t</span> n<span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span>n <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#0000ff; font-weight:bold; '>find</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>.exe</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>|</span><span style='color:#0000ff; '>|</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span>n <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#0000ff; font-weight:bold; '>find</span><span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>.EXE</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>-</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> n <span style='color:#0000ff; '>+</span> <span style='color:#800000; '>4</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span>  objImagePath<span style='color:#0000ff; '>.</span>size<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                    objImagePath <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span>n<span style='color:#0000ff; '>+</span><span style='color:#800000; '>4</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

            <span style='color:#0000ff; '>}</span>
        <span style='color:#0000ff; '>}</span>
        <span style='color:#0000ff; font-weight:bold; '>else</span>
            objImagePath <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>    

<span style='color:#008000; '>//            test.Close();</span>

        <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span> objImagePath<span style='color:#0000ff; '>.</span>empty<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
            ServData<span style='color:#0000ff; '>.</span>sMD5 <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>else</span>
        <span style='color:#0000ff; '>{</span>
            ServData<span style='color:#0000ff; '>.</span>sServicePath <span style='color:#0000ff; '>=</span> RemovePathTaggingFileName<span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            ServData<span style='color:#0000ff; '>.</span>sServiceProg <span style='color:#0000ff; '>=</span> objImagePath<span style='color:#0000ff; '>.</span>substr<span style='color:#0000ff; '>(</span>objImagePath<span style='color:#0000ff; '>.</span>rfind<span style='color:#0000ff; '>(</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>\\</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>+</span><span style='color:#800000; '>1</span><span style='color:#0000ff; '>,</span> objImagePath<span style='color:#0000ff; '>.</span><span style='color:#808080; font-weight:bold; '>npos</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            ServData<span style='color:#0000ff; '>.</span>sServicePath <span style='color:#0000ff; '>=</span> ConvertPathToShortPath<span style='color:#0000ff; '>(</span>ServData<span style='color:#0000ff; '>.</span>sServicePath<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

            <span style='color:#008000; '>//Get MD5 Signature</span>
            <span style='color:#0000ff; font-weight:bold; '>char</span> chBuff<span style='color:#0000ff; '>[</span><span style='color:#800000; '>256</span><span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span> 
            <span style='color:#0000ff; font-weight:bold; '>memset</span><span style='color:#0000ff; '>(</span> chBuff<span style='color:#0000ff; '>,</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span>chBuff<span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>              
            <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span> GetMD5Signature<span style='color:#0000ff; '>(</span> objImagePath<span style='color:#0000ff; '>.</span>c_str<span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span> chBuff<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span>chBuff<span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                ServData<span style='color:#0000ff; '>.</span>sMD5 <span style='color:#0000ff; '>=</span> chBuff<span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; '>}</span>
            <span style='color:#0000ff; font-weight:bold; '>else</span>
                ServData<span style='color:#0000ff; '>.</span>sMD5 <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>else</span>
        ServData<span style='color:#0000ff; '>.</span>sMD5 <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#0000ff; font-weight:bold; '>bool</span> FindServiceImagePath<span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>HKEY</span> hSrvKey<span style='color:#0000ff; '>,</span> std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span><span style='color:#0000ff; '>&amp;</span> objImagePath <span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#008000; '>// Futher code optimization recommended in that function.</span>
    CRegKey                                   objRegInterface<span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>LONG</span>                                   numFuncRes<span style='color:#0000ff; '>;</span>  
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span>                                   numInd<span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>TCHAR</span>                                   strKeyName<span style='color:#0000ff; '>[</span>MAX_PATH<span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span> <span style='color:#008000; '>// Declare as TCHAR - call to API</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span>                                   numKeySize<span style='color:#0000ff; '>;</span>

    <span style='color:#008000; '>// go recursion for every sub-key</span>

    <span style='color:#008000; '>// check gor ImagePath in this key</span>
    <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> GetValueAsString<span style='color:#0000ff; '>(</span> hSrvKey<span style='color:#0000ff; '>,</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>ImagePath</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>,</span>objImagePath<span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
        <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>

     <span style='color:#0000ff; font-weight:bold; '>for</span> <span style='color:#0000ff; '>(</span> numInd <span style='color:#0000ff; '>=</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span> numFuncRes <span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span><span style='color:#0000ff; '>;</span> numFuncRes <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span><span style='color:#0000ff; '>;</span> numInd<span style='color:#0000ff; '>+</span><span style='color:#0000ff; '>+</span> <span style='color:#0000ff; '>)</span> 
         <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> numFuncRes <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>RegEnumKeyEx</span><span style='color:#0000ff; '>(</span> hSrvKey<span style='color:#0000ff; '>,</span>
                                           numInd<span style='color:#0000ff; '>,</span> 
                                           strKeyName<span style='color:#0000ff; '>,</span> 
                                           <span style='color:#0000ff; '>&amp;</span><span style='color:#0000ff; '>(</span>numKeySize <span style='color:#0000ff; '>=</span> MAX_PATH<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span>
                                           <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> 
                                           <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> 
                                           <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> 
                                           <span style='color:#808080; font-weight:bold; '>NULL</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span> <span style='color:#0000ff; '>)</span>
         <span style='color:#0000ff; '>{</span>
            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> objRegInterface<span style='color:#0000ff; '>.</span>Open<span style='color:#0000ff; '>(</span> hSrvKey<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>LPCTSTR</span> <span style='color:#0000ff; '>)</span> strKeyName<span style='color:#0000ff; '>,</span> <span style='color:#808080; font-weight:bold; '>KEY_ENUMERATE_SUB_KEYS</span> <span style='color:#0000ff; '>|</span> <span style='color:#808080; font-weight:bold; '>KEY_QUERY_VALUE</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span> <span style='color:#0000ff; '>)</span>
            <span style='color:#0000ff; '>{</span>
                <span style='color:#008000; '>// Go recursion for that subkey</span>
                <span style='color:#0000ff; font-weight:bold; '>return</span> FindServiceImagePath<span style='color:#0000ff; '>(</span> objRegInterface<span style='color:#0000ff; '>.</span>m_hKey<span style='color:#0000ff; '>,</span> objImagePath <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; '>}</span>
            <span style='color:#0000ff; font-weight:bold; '>else</span>
                <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>
         <span style='color:#0000ff; '>}</span>
         <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#0000ff; font-weight:bold; '>bool</span> GetValueAsString<span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>HKEY</span> hRegKey<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>const</span> _TCHAR<span style='color:#0000ff; '>*</span> strValueName<span style='color:#0000ff; '>,</span> std<span style='color:#0000ff; '>::</span><span style='color:#0000ff; font-weight:bold; '>string</span><span style='color:#0000ff; '>&amp;</span> objValueData <span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>LONG</span>                    numFuncRes<span style='color:#0000ff; '>;</span>  
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span>                    numBuffLen<span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>LPBYTE</span>                    pBuff<span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>bool</span>                    numResult <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span>                    numType<span style='color:#0000ff; '>;</span>
    _TCHAR<span style='color:#0000ff; '>*</span>                 strItoABuffer <span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>DWORD</span>                   numExpStringSize<span style='color:#0000ff; '>;</span>

    <span style='color:#008000; '>// Querry value type</span>
    <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> numFuncRes <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>RegQueryValueEx</span><span style='color:#0000ff; '>(</span> hRegKey<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>LPCTSTR</span><span style='color:#0000ff; '>)</span> strValueName<span style='color:#0000ff; '>,</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>numType<span style='color:#0000ff; '>,</span> <span style='color:#808080; font-weight:bold; '>NULL</span> <span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>numBuffLen <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span> <span style='color:#0000ff; '>)</span> 
    <span style='color:#0000ff; '>{</span>
        <span style='color:#008000; '>// Allocate memory</span>
        <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> pBuff <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>new</span> <span style='color:#0000ff; font-weight:bold; '>BYTE</span><span style='color:#0000ff; '>[</span>numBuffLen<span style='color:#0000ff; '>]</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>NULL</span> <span style='color:#0000ff; '>)</span> 
        <span style='color:#0000ff; '>{</span>
            <span style='color:#008000; '>// Read data</span>
            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> numFuncRes <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>RegQueryValueEx</span><span style='color:#0000ff; '>(</span> hRegKey<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>LPCTSTR</span><span style='color:#0000ff; '>)</span> strValueName<span style='color:#0000ff; '>,</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span> <span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>LPBYTE</span> <span style='color:#0000ff; '>)</span> pBuff <span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>&amp;</span>numBuffLen <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>=</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>ERROR_SUCCESS</span> <span style='color:#0000ff; '>)</span> 
                <span style='color:#008000; '>// Determine the need of convertion</span>
                <span style='color:#0000ff; font-weight:bold; '>switch</span><span style='color:#0000ff; '>(</span> numType <span style='color:#0000ff; '>)</span>
                <span style='color:#0000ff; '>{</span>
                    <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>REG_DWORD</span><span style='color:#e34adc; font-weight:bold; '>:</span>
                        <span style='color:#008000; '>// Convert!</span>
                        <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> strItoABuffer <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>new</span> _TCHAR<span style='color:#0000ff; '>[</span><span style='color:#800000; '>11</span><span style='color:#0000ff; '>]</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>NULL</span> <span style='color:#0000ff; '>)</span> 
                        <span style='color:#0000ff; '>{</span>
                            objValueData <span style='color:#0000ff; '>=</span> itoa<span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>*</span><span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>LPDWORD</span> <span style='color:#0000ff; '>)</span> pBuff <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; '>(</span> _TCHAR<span style='color:#0000ff; '>*</span> <span style='color:#0000ff; '>)</span> strItoABuffer<span style='color:#0000ff; '>,</span> <span style='color:#800000; '>10</span> <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
                            numResult <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>
                        <span style='color:#0000ff; '>}</span>
                        <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>

                    <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>REG_EXPAND_SZ</span><span style='color:#e34adc; font-weight:bold; '>:</span>
                        <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; '>(</span> numExpStringSize <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>ExpandEnvironmentStrings</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>LPCSTR</span><span style='color:#0000ff; '>)</span>pBuff<span style='color:#0000ff; '>,</span><span style='color:#808080; font-weight:bold; '>NULL</span><span style='color:#0000ff; '>,</span><span style='color:#800000; '>0</span><span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span>  <span style='color:#0000ff; '>(</span> strItoABuffer <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>new</span> _TCHAR<span style='color:#0000ff; '>[</span>numExpStringSize<span style='color:#0000ff; '>]</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>!</span><span style='color:#0000ff; '>=</span> <span style='color:#808080; font-weight:bold; '>NULL</span> <span style='color:#0000ff; '>)</span>
                                <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>ExpandEnvironmentStrings</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>LPCSTR</span><span style='color:#0000ff; '>)</span> pBuff<span style='color:#0000ff; '>,</span> strItoABuffer<span style='color:#0000ff; '>,</span> numExpStringSize <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
                                <span style='color:#0000ff; '>{</span>
                                   objValueData <span style='color:#0000ff; '>=</span> strItoABuffer<span style='color:#0000ff; '>;</span>
                                     numResult <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>
                                <span style='color:#0000ff; '>}</span>
                        <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>


                    <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>REG_SZ</span><span style='color:#e34adc; font-weight:bold; '>:</span>
                        <span style='color:#008000; '>// Read directly</span>
                        objValueData <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; '>(</span> _TCHAR<span style='color:#0000ff; '>*</span> <span style='color:#0000ff; '>)</span> pBuff<span style='color:#0000ff; '>;</span>
                        <span style='color:#008000; '>// Indicate success</span>
                        numResult <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>
                    <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>

<span style='color:#e34adc; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;</span><span style='color:#0000ff; font-weight:bold; '>default</span><span style='color:#e34adc; '>:</span>
                        <span style='color:#008000; '>// Not supported value type is being read</span>
                        numResult <span style='color:#0000ff; '>=</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>
                <span style='color:#0000ff; '>}</span>
            <span style='color:#008000; '>// Clean up</span>
            <span style='color:#0000ff; font-weight:bold; '>delete</span><span style='color:#0000ff; '>[</span><span style='color:#0000ff; '>]</span> pBuff<span style='color:#0000ff; '>;</span>
            <span style='color:#0000ff; font-weight:bold; '>if</span> <span style='color:#0000ff; '>(</span> strItoABuffer <span style='color:#0000ff; '>)</span>
                <span style='color:#0000ff; font-weight:bold; '>delete</span><span style='color:#0000ff; '>[</span><span style='color:#0000ff; '>]</span> strItoABuffer<span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>return</span> numResult<span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#0000ff; font-weight:bold; '>bool</span> GetMD5Signature<span style='color:#0000ff; '>(</span> <span style='color:#0000ff; font-weight:bold; '>const</span> <span style='color:#0000ff; font-weight:bold; '>char</span><span style='color:#0000ff; '>*</span> filename<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>char</span><span style='color:#0000ff; '>*</span> pszMD5Buff<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>int</span> iMD5BuffLen <span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>char</span> chBuff<span style='color:#0000ff; '>[</span><span style='color:#800000; '>256</span><span style='color:#0000ff; '>]</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; font-weight:bold; '>memset</span><span style='color:#0000ff; '>(</span> chBuff<span style='color:#0000ff; '>,</span> <span style='color:#800000; '>0</span><span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span>chBuff<span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>if</span><span style='color:#0000ff; '>(</span> MD5File<span style='color:#0000ff; '>(</span> filename<span style='color:#0000ff; '>,</span> chBuff<span style='color:#0000ff; '>,</span> <span style='color:#0000ff; font-weight:bold; '>sizeof</span><span style='color:#0000ff; '>(</span>chBuff<span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span> <span style='color:#0000ff; '>)</span>
    <span style='color:#0000ff; '>{</span>
        <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>false</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>else</span>
    <span style='color:#0000ff; '>{</span>
        <span style='color:#0000ff; font-weight:bold; '>strncpy</span><span style='color:#0000ff; '>(</span>pszMD5Buff<span style='color:#0000ff; '>,</span> chBuff<span style='color:#0000ff; '>,</span> iMD5BuffLen<span style='color:#0000ff; '>)</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>return</span> <span style='color:#0000ff; font-weight:bold; '>true</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; '>}</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#008000; '>// get current status of the services</span>
<span style='color:#0000ff; font-weight:bold; '>string</span> GetCurrentStatus<span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>const</span> <span style='color:#0000ff; font-weight:bold; '>DWORD</span> p_dwType<span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>string</span> sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>switch</span> <span style='color:#0000ff; '>(</span>p_dwType<span style='color:#0000ff; '>)</span>
    <span style='color:#0000ff; '>{</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_STOPPED</span><span style='color:#e34adc; font-weight:bold; '>:</span>               sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Off</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                                    <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_START_PENDING</span><span style='color:#e34adc; font-weight:bold; '>:</span>         sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Starting</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                               <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_STOP_PENDING</span><span style='color:#e34adc; font-weight:bold; '>:</span>          sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Stopping</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                               <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_RUNNING</span><span style='color:#e34adc; font-weight:bold; '>:</span>               sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>On</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                                     <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_CONTINUE_PENDING</span><span style='color:#e34adc; font-weight:bold; '>:</span>      sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Continue is pending</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                    <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_PAUSE_PENDING</span><span style='color:#e34adc; font-weight:bold; '>:</span>         sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Pause is pending</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                       <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_PAUSED</span><span style='color:#e34adc; font-weight:bold; '>:</span>                sStatus <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Paused</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                                 <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>return</span> sStatus<span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>

<span style='color:#008000; '>// get type of the service</span>
<span style='color:#0000ff; font-weight:bold; '>string</span> GetTypeOfService<span style='color:#0000ff; '>(</span><span style='color:#0000ff; font-weight:bold; '>const</span> <span style='color:#0000ff; font-weight:bold; '>DWORD</span> p_dwType<span style='color:#0000ff; '>)</span>
<span style='color:#0000ff; '>{</span>
    <span style='color:#0000ff; font-weight:bold; '>string</span> sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>

    <span style='color:#0000ff; font-weight:bold; '>switch</span> <span style='color:#0000ff; '>(</span>p_dwType<span style='color:#0000ff; '>)</span>
    <span style='color:#0000ff; '>{</span>    
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_WIN32_OWN_PROCESS</span><span style='color:#e34adc; font-weight:bold; '>:</span>     sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Run its own process</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                      <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_WIN32_SHARE_PROCESS</span><span style='color:#e34adc; font-weight:bold; '>:</span>   sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Share a process with other application</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>   <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_KERNEL_DRIVER</span><span style='color:#e34adc; font-weight:bold; '>:</span>         sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Device driver</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                            <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_FILE_SYSTEM_DRIVER</span><span style='color:#e34adc; font-weight:bold; '>:</span>    sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>File system driver</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>                       <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
        <span style='color:#0000ff; font-weight:bold; '>case </span><span style='color:#808080; font-weight:bold; '>SERVICE_INTERACTIVE_PROCESS</span><span style='color:#e34adc; font-weight:bold; '>:</span>   sType <span style='color:#0000ff; '>=</span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>Service can interact with desktop</span><span style='color:#0000e6; '>"</span><span style='color:#0000ff; '>;</span>        <span style='color:#0000ff; font-weight:bold; '>break</span><span style='color:#0000ff; '>;</span>
    <span style='color:#0000ff; '>}</span>
    <span style='color:#0000ff; font-weight:bold; '>return</span> sType<span style='color:#0000ff; '>;</span>
<span style='color:#0000ff; '>}</span>
</pre>