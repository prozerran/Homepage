<pre style='color:#000020;background:#f6f8ff;'><span style='color:#200080; font-weight:bold; '>package</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>controllers</span><span style='color:#406080; '>;</span>

<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> java</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>time</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>LocalDate</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> java</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>time</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>LocalTime</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> java</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>util</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>Date</span><span style='color:#406080; '>;</span>

<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> javax</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>servlet</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>http</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>HttpServletRequest</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> javax</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>servlet</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>http</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>HttpServletResponse</span><span style='color:#406080; '>;</span>

<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>beans</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>factory</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>Autowired</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>cache</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>Cacheable</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>http</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>HttpStatus</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>http</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ResponseEntity</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>scheduling</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>Async</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>stereotype</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>Controller</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>bind</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>PathVariable</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>bind</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>RequestMapping</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>bind</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>RequestParam</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>bind</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ResponseBody</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>bind</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ResponseStatus</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> org</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>springframework</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>web</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>servlet</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>mvc</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>method</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>annotation</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>StreamingResponseBody</span><span style='color:#406080; '>;</span>

<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>alibaba</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>fastjson</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>JSON</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>AppConstants</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>SPCommon</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>SPConfig</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartFileImporter</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>HttpClient</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>TickerFileImporter</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>AppConstants</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartInterval</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>entities</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataDaily</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>entities</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataHour</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>entities</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataMinute</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>entities</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataSecond</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>entities</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataTicker</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>app</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>LogTailer</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ReadOrder</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>models</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataData</span><span style='color:#406080; '>;</span>
<span style='color:#200080; font-weight:bold; '>import</span><span style='color:#004a43; '> com</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>sp</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>services</span><span style='color:#308080; '>.</span><span style='color:#004a43; '>ChartdataService</span><span style='color:#406080; '>;</span>

<span style='color:#3f7f8f; '>/**</span>
<span style='color:#3f7f8f; '>&#xa0;</span><span style='color:#7f9fbf; font-weight:bold; '>*</span><span style='color:#3f7f8f; '> ChartdataSecond controller.</span>
<span style='color:#3f7f8f; '>&#xa0;*/</span>
<span style='color:#7f9fbf; font-weight:bold; '>@Controller</span>
<span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#200080; font-weight:bold; '>class</span> ChartdataController <span style='color:#406080; '>{</span>

    <span style='color:#200080; font-weight:bold; '>private</span> ChartdataService cdss<span style='color:#406080; '>;</span>

    <span style='color:#7f9fbf; font-weight:bold; '>@Autowired</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#7779bb; '>void</span> setChartdataService<span style='color:#308080; '>(</span>ChartdataService chartdataService<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
        <span style='color:#200080; font-weight:bold; '>this</span><span style='color:#308080; '>.</span>cdss <span style='color:#308080; '>=</span> chartdataService<span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span>   
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("cutofftime/{prod_code}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#6679aa; font-weight:bold; '>String</span> getCutOffTime<span style='color:#308080; '>(</span><span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> prod_code<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    	LocalTime dt <span style='color:#308080; '>=</span> cdss<span style='color:#308080; '>.</span>getCutOffTime<span style='color:#308080; '>(</span>prod_code<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    	
    	<span style='color:#200080; font-weight:bold; '>return</span> dt<span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span>     
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("houseclean")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@Async</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#7779bb; '>void</span> doHouseClean<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>InterruptedException</span> <span style='color:#406080; '>{</span>      	
    	cdss<span style='color:#308080; '>.</span>doHouseClean<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"tb.chartdata_second"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	cdss<span style='color:#308080; '>.</span>doHouseClean<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"tb.chartdata_ticker"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	cdss<span style='color:#308080; '>.</span>doHouseClean<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"tb.chartdata_minute"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	cdss<span style='color:#308080; '>.</span>doHouseClean<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"tb.chartdata_hour"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	cdss<span style='color:#308080; '>.</span>doHouseClean<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"tb.chartdata_daily"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span> 
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("evictcache")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@Async</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#7779bb; '>void</span> doEvictCache<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    	cdss<span style='color:#308080; '>.</span>doEvictCache<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span>    
    
    <span style='color:#595979; '>// recover data from remote db:trading [old]</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recover/trading/{src_ip_addr}/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span> doRecoveryTrading<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> src_ip_addr<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_s <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s/pserver/chartdata_recoverdata.php?prod_code=FULL&amp;data_type=sec&amp;from_time=%s&amp;to_time=%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_m <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s/pserver/chartdata_recoverdata.php?prod_code=FULL&amp;data_type=min&amp;from_time=%s&amp;to_time=%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_h <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s/pserver/chartdata_recoverdata.php?prod_code=FULL&amp;data_type=hour&amp;from_time=%s&amp;to_time=%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_d <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s/pserver/chartdata_recoverdata.php?prod_code=FULL&amp;data_type=day&amp;from_time=%s&amp;to_time=%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	HttpClient hce <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>new</span> HttpClient<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    	
        
    	<span style='color:#595979; '>// recover for db second,minute,hour,daily</span>
        cdss<span style='color:#308080; '>.</span>putChartDataLegacy<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_s<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> ChartInterval<span style='color:#308080; '>.</span>SECOND<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        cdss<span style='color:#308080; '>.</span>putChartDataLegacy<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_m<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> ChartInterval<span style='color:#308080; '>.</span>MINUTE<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        cdss<span style='color:#308080; '>.</span>putChartDataLegacy<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_h<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> ChartInterval<span style='color:#308080; '>.</span>HOUR<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
        cdss<span style='color:#308080; '>.</span>putChartDataLegacy<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_d<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> ChartInterval<span style='color:#308080; '>.</span>DAILY<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
                 
		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Recovery done!"</span><span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
    <span style='color:#406080; '>}</span>      
        
    <span style='color:#595979; '>// recover data from remote db:trading_chart [new]</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recover/trading_chart/{src_ip_addr}/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span> doRecoveryTradingChart<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> src_ip_addr<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
    	
        <span style='color:#6679aa; font-weight:bold; '>String</span> port <span style='color:#308080; '>=</span> SPConfig<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>GetProperty<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http.port"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_s <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s:%s/recoverdata/trading_chart/sec/%s/%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> port<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_m <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s:%s/recoverdata/trading_chart/min/%s/%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> port<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_h <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s:%s/recoverdata/trading_chart/hour/%s/%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> port<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
        
        <span style='color:#6679aa; font-weight:bold; '>String</span> url_d <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>.</span>format<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"http://%s:%s/recoverdata/trading_chart/day/%s/%s"</span><span style='color:#308080; '>,</span>
        		src_ip_addr<span style='color:#308080; '>,</span> port<span style='color:#308080; '>,</span> from_unixtime<span style='color:#308080; '>,</span> to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	HttpClient hce <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>new</span> HttpClient<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    	
        
    	<span style='color:#595979; '>// recover for db second,minute,hour,daily</span>
        cdss<span style='color:#308080; '>.</span>setChartDataSecond<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_s<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
        cdss<span style='color:#308080; '>.</span>setChartDataMinute<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_m<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
        cdss<span style='color:#308080; '>.</span>setChartDataHour<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_h<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
        cdss<span style='color:#308080; '>.</span>setChartDataDaily<span style='color:#308080; '>(</span>hce<span style='color:#308080; '>.</span>get<span style='color:#308080; '>(</span>url_d<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>         
         
		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span><span style='color:#308080; '>(</span><span style='color:#1060b6; '>"Recovery done!"</span><span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
    <span style='color:#406080; '>}</span>    
 
    <span style='color:#595979; '>// recover data from remote db:trading_chart [new]</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recoverdata/trading_chart/sec/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataSecond<span style='color:#308080; '>></span> doRecoverDataTradingChartSecond<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#200080; font-weight:bold; '>return</span> cdss<span style='color:#308080; '>.</span>getChartDataSecond<span style='color:#308080; '>(</span>from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 	   	       
    <span style='color:#406080; '>}</span> 
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recoverdata/trading_chart/min/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataMinute<span style='color:#308080; '>></span> doRecoverDataTradingChartMinute<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#200080; font-weight:bold; '>return</span> cdss<span style='color:#308080; '>.</span>getChartDataMinute<span style='color:#308080; '>(</span>from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 	   	       
    <span style='color:#406080; '>}</span> 
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recoverdata/trading_chart/hour/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataHour<span style='color:#308080; '>></span> doRecoverDataTradingChartHour<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#200080; font-weight:bold; '>return</span> cdss<span style='color:#308080; '>.</span>getChartDataHour<span style='color:#308080; '>(</span>from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 	   	       
    <span style='color:#406080; '>}</span> 
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recoverdata/trading_chart/day/{from_unixtime}/{to_unixtime}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataDaily<span style='color:#308080; '>></span> doRecoverDataTradingChartDaily<span style='color:#308080; '>(</span>	
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_unixtime<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_unixtime<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span> <span style='color:#406080; '>{</span>
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_unixtime<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#200080; font-weight:bold; '>return</span> cdss<span style='color:#308080; '>.</span>getChartDataDaily<span style='color:#308080; '>(</span>from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 	   	       
    <span style='color:#406080; '>}</span>     
        
    <span style='color:#595979; '>// recover data locally from pserver csv files to DB</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("recover/file/{from_yyyymmdd}/{to_yyyymmdd}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@Async</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#7779bb; '>void</span> doRecoveryFile<span style='color:#308080; '>(</span>
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_yyyymmdd<span style='color:#308080; '>,</span> 
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_yyyymmdd<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>InterruptedException</span> <span style='color:#406080; '>{</span>    	
    	doConsolidation<span style='color:#308080; '>(</span>from_yyyymmdd<span style='color:#308080; '>,</span> to_yyyymmdd<span style='color:#308080; '>,</span> <span style='color:#200080; font-weight:bold; '>true</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    	
    <span style='color:#406080; '>}</span>    
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("consolidate/{from_yyyymmdd}/{to_yyyymmdd}/{add}")</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseStatus(code = HttpStatus.OK)</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@Async</span>
    <span style='color:#200080; font-weight:bold; '>public</span> <span style='color:#7779bb; '>void</span> doConsolidation<span style='color:#308080; '>(</span>
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_yyyymmdd<span style='color:#308080; '>,</span> <span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_yyyymmdd<span style='color:#308080; '>,</span>     		
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>Boolean</span> add<span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>InterruptedException</span> <span style='color:#406080; '>{</span>  
    	
		LocalDate dt_from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateFromStringFormat<span style='color:#308080; '>(</span>from_yyyymmdd<span style='color:#308080; '>,</span> <span style='color:#1060b6; '>"yyyyMMdd"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>   	    	
		LocalDate dt_to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateFromStringFormat<span style='color:#308080; '>(</span>to_yyyymmdd<span style='color:#308080; '>,</span> <span style='color:#1060b6; '>"yyyyMMdd"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
		LocalDate dt <span style='color:#308080; '>=</span> dt_from<span style='color:#406080; '>;</span>
		
		<span style='color:#200080; font-weight:bold; '>while</span> <span style='color:#308080; '>(</span><span style='color:#308080; '>!</span>dt<span style='color:#308080; '>.</span>isAfter<span style='color:#308080; '>(</span>dt_to<span style='color:#308080; '>)</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
	
			<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>add<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
				<span style='color:#595979; '>// parse files</span>
				ChartFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>StartOnDate<span style='color:#308080; '>(</span>dt<span style='color:#308080; '>,</span> ReadOrder<span style='color:#308080; '>.</span>UNTIL_EOF<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
				TickerFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>StartOnDate<span style='color:#308080; '>(</span>dt<span style='color:#308080; '>,</span> ReadOrder<span style='color:#308080; '>.</span>UNTIL_EOF<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	
						
				<span style='color:#595979; '>// wait until parsing finishes</span>
				<span style='color:#200080; font-weight:bold; '>while</span> <span style='color:#308080; '>(</span><span style='color:#308080; '>!</span>ChartFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>IsDone<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span> <span style='color:#6679aa; font-weight:bold; '>Thread</span><span style='color:#308080; '>.</span>sleep<span style='color:#308080; '>(</span><span style='color:#008c00; '>5000</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
				<span style='color:#200080; font-weight:bold; '>while</span> <span style='color:#308080; '>(</span><span style='color:#308080; '>!</span>TickerFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>IsDone<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span> <span style='color:#6679aa; font-weight:bold; '>Thread</span><span style='color:#308080; '>.</span>sleep<span style='color:#308080; '>(</span><span style='color:#008c00; '>5000</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>				
			<span style='color:#406080; '>}</span>
			
			<span style='color:#595979; '>// mass populate data in chartdata tables</span>
			cdss<span style='color:#308080; '>.</span>consolidateChartDataTables<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"ChartdataMinute"</span><span style='color:#308080; '>,</span> dt<span style='color:#308080; '>,</span> <span style='color:#008c00; '>60</span><span style='color:#006600; '>L</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
			cdss<span style='color:#308080; '>.</span>consolidateChartDataTables<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"ChartdataHour"</span><span style='color:#308080; '>,</span> dt<span style='color:#308080; '>,</span> <span style='color:#008c00; '>3600</span><span style='color:#006600; '>L</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	
			cdss<span style='color:#308080; '>.</span>consolidateChartDataTables<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"ChartdataDaily"</span><span style='color:#308080; '>,</span> dt<span style='color:#308080; '>,</span> <span style='color:#008c00; '>86400</span><span style='color:#006600; '>L</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>		
			
			dt <span style='color:#308080; '>=</span> dt<span style='color:#308080; '>.</span>plusDays<span style='color:#308080; '>(</span><span style='color:#008c00; '>1</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
		<span style='color:#406080; '>}</span>
		
		<span style='color:#595979; '>// </span><span style='color:#ffffff; background:#808000; '>TODO: May need to refactor so that it can be run in parallel</span>
		<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>add<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
			<span style='color:#595979; '>// because we used our instance to reparse files, we need to restart the parse service for today</span>
			<span style='color:#595979; '>// Note that recovery of data SHOULD be done after business/trading hours</span>
			TickerFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>StartService<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
			ChartFileImporter<span style='color:#308080; '>.</span>getInstance<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>StartService<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
		<span style='color:#406080; '>}</span>
    <span style='color:#406080; '>}</span>  
    
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("ticker/query/{prod_code}/{bars}")</span>     
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span> queryTicker<span style='color:#308080; '>(</span> 
    		HttpServletRequest req<span style='color:#308080; '>,</span> 
    		HttpServletResponse resp<span style='color:#308080; '>,</span>    		
    		<span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>String</span> prod_code<span style='color:#308080; '>,</span> <span style='color:#7f9fbf; font-weight:bold; '>@PathVariable</span> <span style='color:#6679aa; font-weight:bold; '>Integer</span> bars               
            <span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span>
    <span style='color:#406080; '>{</span>    	
    	<span style='color:#595979; '>// query our data from DB/cache</span>
		<span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataTicker<span style='color:#308080; '>></span> cdt <span style='color:#308080; '>=</span> cdss<span style='color:#308080; '>.</span>getTickerData<span style='color:#308080; '>(</span>prod_code<span style='color:#308080; '>,</span> bars<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>     	

		<span style='color:#595979; '>// return ticker format</span>
		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/html"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span><span style='color:#308080; '>(</span>ChartdataTicker<span style='color:#308080; '>.</span>getTickerTextCSV<span style='color:#308080; '>(</span>cdt<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span>    
    
    <span style='color:#595979; '>//@RequestMapping("ticker/query")</span>
    <span style='color:#595979; '>//URL mapping made compatible with old [php] format</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("pserver/ticker_query.php")</span>     
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>
    <span style='color:#200080; font-weight:bold; '>public</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span> getTicker<span style='color:#308080; '>(</span> 
    		HttpServletRequest req<span style='color:#308080; '>,</span> 
    		HttpServletResponse resp<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam</span> <span style='color:#6679aa; font-weight:bold; '>String</span> prod_code<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam</span> <span style='color:#6679aa; font-weight:bold; '>Integer</span> second<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam(value = "from_time", required = false)</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_time                   
            <span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span>
    <span style='color:#406080; '>{</span>
    	<span style='color:#595979; '>// set some limits</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>&lt;</span> <span style='color:#008c00; '>60</span><span style='color:#308080; '>)</span> second <span style='color:#308080; '>=</span> <span style='color:#008c00; '>60</span><span style='color:#406080; '>;</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>></span> <span style='color:#008c00; '>900</span><span style='color:#308080; '>)</span> second <span style='color:#308080; '>=</span> <span style='color:#008c00; '>900</span><span style='color:#406080; '>;</span>   
    	
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>from_time <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    		<span style='color:#7779bb; '>long</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDayStartDate<span style='color:#308080; '>(</span><span style='color:#008c00; '>0</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		from_time <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>Long</span><span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span>from<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>   		
    	<span style='color:#406080; '>}</span>
    	
    	<span style='color:#595979; '>// to_time not set, set some arbitrary future date</span>
		<span style='color:#7779bb; '>long</span> future <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetEpochTime<span style='color:#308080; '>(</span><span style='color:#008c00; '>21001231</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
		<span style='color:#6679aa; font-weight:bold; '>String</span> to_time <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>Long</span><span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span>future<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>  
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_time<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_time<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#595979; '>// query our data from DB/cache</span>
		<span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataData<span style='color:#308080; '>></span> cdd <span style='color:#308080; '>=</span> cdss<span style='color:#308080; '>.</span>getChartDataCached<span style='color:#308080; '>(</span>prod_code<span style='color:#308080; '>,</span> second<span style='color:#308080; '>,</span> from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>     	

		<span style='color:#595979; '>// return ticker format</span>
		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/html"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span><span style='color:#6679aa; font-weight:bold; '>String</span><span style='color:#308080; '>></span><span style='color:#308080; '>(</span>ChartdataData<span style='color:#308080; '>.</span>getTickerTextCSV<span style='color:#308080; '>(</span>cdd<span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    <span style='color:#406080; '>}</span>       
    
    <span style='color:#595979; '>//@RequestMapping("chartdata/query")</span>
    <span style='color:#595979; '>//URL mapping made compatible with old [php] format</span>
    <span style='color:#7f9fbf; font-weight:bold; '>@RequestMapping("pserver/chartdata_query.php")</span>    
    <span style='color:#7f9fbf; font-weight:bold; '>@ResponseBody</span>	
    <span style='color:#200080; font-weight:bold; '>public</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span> getChartData<span style='color:#308080; '>(</span> 
    		HttpServletRequest req<span style='color:#308080; '>,</span> 
    		HttpServletResponse resp<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam</span> <span style='color:#6679aa; font-weight:bold; '>String</span> prod_code<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam</span> <span style='color:#6679aa; font-weight:bold; '>Integer</span> second<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam(value = "from_time", required = false)</span> <span style='color:#6679aa; font-weight:bold; '>String</span> from_time<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam(value = "to_time", required = false)</span> <span style='color:#6679aa; font-weight:bold; '>String</span> to_time<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam(value = "days", required = false)</span> <span style='color:#6679aa; font-weight:bold; '>Integer</span> days<span style='color:#308080; '>,</span>
            <span style='color:#7f9fbf; font-weight:bold; '>@RequestParam(value = "data_mode", required = false)</span> <span style='color:#6679aa; font-weight:bold; '>Integer</span> data_mode                      
            <span style='color:#308080; '>)</span> <span style='color:#200080; font-weight:bold; '>throws</span> <span style='color:#6679aa; font-weight:bold; '>Exception</span>
    <span style='color:#406080; '>{</span>
    	<span style='color:#595979; '>// set some limits</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>&lt;</span> <span style='color:#008c00; '>5</span><span style='color:#308080; '>)</span> second <span style='color:#308080; '>=</span> <span style='color:#008c00; '>5</span><span style='color:#406080; '>;</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>></span> <span style='color:#008c00; '>86400</span><span style='color:#308080; '>)</span> second <span style='color:#308080; '>=</span> <span style='color:#008c00; '>86400</span><span style='color:#406080; '>;</span>    	
    	
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>data_mode <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span><span style='color:#308080; '>)</span>
    		data_mode <span style='color:#308080; '>=</span> AppConstants<span style='color:#308080; '>.</span>DATAMODE_TEXT_CSV<span style='color:#406080; '>;</span>   	
    	
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>from_time <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span> <span style='color:#308080; '>&amp;</span><span style='color:#308080; '>&amp;</span> <span style='color:#308080; '>(</span>days <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span> <span style='color:#308080; '>|</span><span style='color:#308080; '>|</span> days <span style='color:#308080; '>&lt;</span><span style='color:#308080; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    		<span style='color:#595979; '>// seconds: 5, 10, 30, ... get only from chartdata_second</span>
    		<span style='color:#595979; '>// seconds: 60, 3600, ... get 1 day from chartdata_second + 8 day history from respective table    		</span>
    		<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>&lt;</span> <span style='color:#008c00; '>60</span><span style='color:#308080; '>)</span> 			days <span style='color:#308080; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#406080; '>;</span>
    		<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>&lt;</span> <span style='color:#008c00; '>3600</span><span style='color:#308080; '>)</span>		days <span style='color:#308080; '>=</span> <span style='color:#008c00; '>8</span><span style='color:#406080; '>;</span>		<span style='color:#595979; '>// minute</span>
    		<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>&lt;</span> <span style='color:#008c00; '>86400</span><span style='color:#308080; '>)</span>	days <span style='color:#308080; '>=</span> <span style='color:#008c00; '>91</span><span style='color:#406080; '>;</span>		<span style='color:#595979; '>// hourly</span>
    		<span style='color:#200080; font-weight:bold; '>else</span>						days <span style='color:#308080; '>=</span> <span style='color:#008c00; '>15001</span><span style='color:#406080; '>;</span>	<span style='color:#595979; '>// daily</span>
    	<span style='color:#406080; '>}</span>   
    	
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>from_time <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    		<span style='color:#7779bb; '>long</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDayStartDate<span style='color:#308080; '>(</span>days<span style='color:#308080; '>-</span><span style='color:#008c00; '>1</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		from_time <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>Long</span><span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span>from<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>   		
    	<span style='color:#406080; '>}</span>    		
    	
    	<span style='color:#595979; '>// to_time not set, set some arbitrary future date</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>to_time <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span><span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    		<span style='color:#7779bb; '>long</span> future <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetEpochTime<span style='color:#308080; '>(</span><span style='color:#008c00; '>21001231</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		to_time <span style='color:#308080; '>=</span> <span style='color:#6679aa; font-weight:bold; '>Long</span><span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span>future<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#406080; '>}</span>  
    	
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> from <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>from_time<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#6679aa; font-weight:bold; '>Date</span> to <span style='color:#308080; '>=</span> SPCommon<span style='color:#308080; '>.</span>GetDateTime<span style='color:#308080; '>(</span>to_time<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#595979; '>// query our data from DB/cache</span>
    	<span style='color:#6679aa; font-weight:bold; '>Iterable</span><span style='color:#308080; '>&lt;</span>ChartdataData<span style='color:#308080; '>></span> cdd <span style='color:#308080; '>=</span> <span style='color:#200080; font-weight:bold; '>null</span><span style='color:#406080; '>;</span>
    	
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>second <span style='color:#308080; '>></span><span style='color:#308080; '>=</span> <span style='color:#008c00; '>60</span><span style='color:#308080; '>)</span>    	
    		cdd <span style='color:#308080; '>=</span> cdss<span style='color:#308080; '>.</span>getChartDataCached<span style='color:#308080; '>(</span>prod_code<span style='color:#308080; '>,</span> second<span style='color:#308080; '>,</span> from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>		<span style='color:#595979; '>// cache-able history version     	</span>
    	<span style='color:#200080; font-weight:bold; '>else</span>
    		cdd <span style='color:#308080; '>=</span> cdss<span style='color:#308080; '>.</span>getChartDataCurrent<span style='color:#308080; '>(</span>prod_code<span style='color:#308080; '>,</span> second<span style='color:#308080; '>,</span> from<span style='color:#308080; '>,</span> to<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	<span style='color:#595979; '>// current/today table only</span>

		<span style='color:#595979; '>// determine which mode to return in</span>
    	<span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>data_mode <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> AppConstants<span style='color:#308080; '>.</span>DATAMODE_DATA_ARRAY<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>
    		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/html"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
    		<span style='color:#6679aa; font-weight:bold; '>String</span> ss <span style='color:#308080; '>=</span> ChartdataData<span style='color:#308080; '>.</span>getChartdataArray<span style='color:#308080; '>(</span>cdd<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		<span style='color:#200080; font-weight:bold; '>final</span> StreamingResponseBody body <span style='color:#308080; '>=</span> out <span style='color:#308080; '>-</span><span style='color:#308080; '>></span> out<span style='color:#308080; '>.</span>write<span style='color:#308080; '>(</span>ss<span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>getBytes<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>,</span> ss<span style='color:#308080; '>.</span>length<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span><span style='color:#308080; '>(</span>body<span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#406080; '>}</span>
    	<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>data_mode <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> AppConstants<span style='color:#308080; '>.</span>DATAMODE_TEXT_CSV<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span> <span style='color:#595979; '>// default			</span>
    		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/html"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
    		<span style='color:#6679aa; font-weight:bold; '>String</span> ss <span style='color:#308080; '>=</span> ChartdataData<span style='color:#308080; '>.</span>getChartdataTextCSV<span style='color:#308080; '>(</span>cdd<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		<span style='color:#200080; font-weight:bold; '>final</span> StreamingResponseBody body <span style='color:#308080; '>=</span> out <span style='color:#308080; '>-</span><span style='color:#308080; '>></span> out<span style='color:#308080; '>.</span>write<span style='color:#308080; '>(</span>ss<span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>getBytes<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>,</span> ss<span style='color:#308080; '>.</span>length<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span><span style='color:#308080; '>(</span>body<span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    	<span style='color:#406080; '>}</span>    	
    	<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>data_mode <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> AppConstants<span style='color:#308080; '>.</span>DATAMODE_JAVASCRIPT<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>    			
    		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/javascript"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 	<span style='color:#595979; '>// no idea why this is JS in php</span>
    		<span style='color:#6679aa; font-weight:bold; '>String</span> ss <span style='color:#308080; '>=</span> ChartdataData<span style='color:#308080; '>.</span>getChartdataJavaScript<span style='color:#308080; '>(</span>cdd<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		<span style='color:#200080; font-weight:bold; '>final</span> StreamingResponseBody body <span style='color:#308080; '>=</span> out <span style='color:#308080; '>-</span><span style='color:#308080; '>></span> out<span style='color:#308080; '>.</span>write<span style='color:#308080; '>(</span>ss<span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>getBytes<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>,</span> ss<span style='color:#308080; '>.</span>length<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span><span style='color:#308080; '>(</span>body<span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	
    	<span style='color:#406080; '>}</span>
    	<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#200080; font-weight:bold; '>if</span> <span style='color:#308080; '>(</span>data_mode <span style='color:#308080; '>=</span><span style='color:#308080; '>=</span> AppConstants<span style='color:#308080; '>.</span>DATAMODE_JSON_ARRAY<span style='color:#308080; '>)</span> <span style='color:#406080; '>{</span>        	
    		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"application/json"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>   
    		<span style='color:#6679aa; font-weight:bold; '>String</span> ss <span style='color:#308080; '>=</span> JSON<span style='color:#308080; '>.</span>toJSONString<span style='color:#308080; '>(</span>cdd<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	
    		<span style='color:#200080; font-weight:bold; '>final</span> StreamingResponseBody body <span style='color:#308080; '>=</span> out <span style='color:#308080; '>-</span><span style='color:#308080; '>></span> out<span style='color:#308080; '>.</span>write<span style='color:#308080; '>(</span>ss<span style='color:#308080; '>.</span>getBytes<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>,</span> ss<span style='color:#308080; '>.</span>length<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span><span style='color:#308080; '>(</span>body<span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>OK<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>	    		
    	<span style='color:#406080; '>}</span>    	
    	<span style='color:#200080; font-weight:bold; '>else</span> <span style='color:#406080; '>{</span>	<span style='color:#595979; '>// should not come here    			</span>
    		resp<span style='color:#308080; '>.</span>setContentType<span style='color:#308080; '>(</span><span style='color:#1060b6; '>"text/html"</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span> 
    		<span style='color:#6679aa; font-weight:bold; '>String</span> ss <span style='color:#308080; '>=</span> ChartdataData<span style='color:#308080; '>.</span>getChartdataHeader<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>
    		<span style='color:#200080; font-weight:bold; '>final</span> StreamingResponseBody body <span style='color:#308080; '>=</span> out <span style='color:#308080; '>-</span><span style='color:#308080; '>></span> out<span style='color:#308080; '>.</span>write<span style='color:#308080; '>(</span>ss<span style='color:#308080; '>.</span>toString<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>.</span>getBytes<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#308080; '>,</span> ss<span style='color:#308080; '>.</span>length<span style='color:#308080; '>(</span><span style='color:#308080; '>)</span><span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    		<span style='color:#200080; font-weight:bold; '>return</span> <span style='color:#200080; font-weight:bold; '>new</span> ResponseEntity<span style='color:#308080; '>&lt;</span>StreamingResponseBody<span style='color:#308080; '>></span><span style='color:#308080; '>(</span>body<span style='color:#308080; '>,</span> HttpStatus<span style='color:#308080; '>.</span>BAD_REQUEST<span style='color:#308080; '>)</span><span style='color:#406080; '>;</span>    		
    	<span style='color:#406080; '>}</span>
    <span style='color:#406080; '>}</span>
<span style='color:#406080; '>}</span>


</pre>
<!--Created using ToHtml.com on 2021-06-08 06:48:59 UTC -->